<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>复刻一个Pixel Art水体渲染实现 | Granvallen;Nest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'bf1ecb4728a04112cb191bc2e62aa815';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">复刻一个Pixel Art水体渲染实现</h1><a id="logo" href="/.">Granvallen;Nest</a><p class="description">面白く生きる</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/about/"><i class="fa fa-terminal"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">复刻一个Pixel Art水体渲染实现</h1><div class="post-meta">Dec 21, 2024<span> | </span><span class="category"><a href="/categories/Lab/">Lab</a><a href="/categories/Lab/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/">计算机图形学</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 8,850</span><span class="post-meta-item-text"> 字</span></span></span><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E5%88%BB2d%E6%B0%B4%E4%BD%93%E6%B8%B2%E6%9F%93"><span class="toc-number">1.</span> <span class="toc-text">复刻2d水体渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B0%B4%E4%BD%93%E7%9A%84tile"><span class="toc-number">1.1.</span> <span class="toc-text">水体的tile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2d%E6%B0%B4%E4%BD%93%E7%9A%84%E5%80%92%E5%BD%B1%E4%B8%8E%E6%B0%B4%E6%B7%B1"><span class="toc-number">2.</span> <span class="toc-text">2d水体的倒影与水深</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-number">2.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">2.2.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B0%B4%E4%B8%AD%E7%89%A9%E4%BD%93%E5%A4%84%E7%90%86%E4%B8%8ESprite%E5%90%88%E6%89%B9"><span class="toc-number">2.3.</span> <span class="toc-text">水中物体处理与Sprite合批</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">附录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#common-hlsl-%E4%B8%8E-pixel-art-hlsl"><span class="toc-number">3.1.</span> <span class="toc-text">common.hlsl 与 pixel_art.hlsl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tilemap-%E7%9A%84%E7%BC%9D%E9%9A%99%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.2.</span> <span class="toc-text">Tilemap 的缝隙问题与解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">其他参考</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2d%E6%B8%B8%E6%88%8F%E6%B0%B4%E4%BD%93%E7%9A%84%E5%8F%82%E8%80%83"><span class="toc-number">4.1.</span> <span class="toc-text">2d游戏水体的参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3d%E6%B8%B8%E6%88%8F%E6%B0%B4%E4%BD%93%E7%9A%84%E5%8F%82%E8%80%83"><span class="toc-number">4.2.</span> <span class="toc-text">3d游戏水体的参考</span></a></li></ol></li></ol></div></div><div class="post-content"><p>jojo, 这是我今年最后的更新了! 咳咳, 这次继续来现学现卖, 分享下看到的 Pixel Art 相关的渲染技术. 前段时间油管上看到一个非常棒的 Pixel Art 水体渲染的分享, 是由游戏开发者 jess 制作的 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=pGOLstWBCDA&amp;t=17s">How I Created 2D Pixel Art Water - Unity Shader Graph</a>. 这虽然是她的第一个视频, 但是质量高得可怕, 不仅制作过程思路清晰, 最后实现的效果也相当不错. 那话怎么说的来着, 新人都是怪物. 此后的几次分享同样好评如潮, 因为内容都是我感兴趣的领域, 所以我大概都会稍微研究一下. </p>
<span id="more"></span>
<p>回到正题, jess 在这个视频中分享了她如何通过 unity shader graph 实现 Pixel Art 风格的水体, 并且开源了<a target="_blank" rel="noopener" href="https://github.com/jess-hammer/2d-pixel-water-shader/tree/main">示例工程</a>, 还非常”贴心”地更新了 godot 的实现(似乎 jess 也在之前的 unity 收费政策风波中打算把工程迁移至 godot). 如果你只关心实现, jess 的分享显然比这干巴巴的文字直观生动多了, 推荐直接去看.</p>
<p>而在这篇文章中, 我首先尝试用 unity 的 shaderlab 重写了 jess 的实现, 以便更容易地在项目中复用. 接着又试着实现一个2d水体倒影和水深效果的方案, 以期让水体与其他物体的交互看起来更生动. 事先申明, 这篇文章可能会涉及多个话题, 包括2d水体渲染、URP、shader、tilemap、渲染合批, 这每一个话题都是大坑, 也都值得单独拿出来讲. 如果你曾关注过这些关键词, 那么这个分享就不会有太多障碍, 可能还能些许帮到你. 同时必须说这些分享也还没有经过足够的实践, 仍需进一步迭代和验证. </p>
<h1 id="复刻2d水体渲染"><a href="#复刻2d水体渲染" class="headerlink" title="复刻2d水体渲染"></a>复刻2d水体渲染</h1><p>水体渲染算是图形学中比较基础且重要的部分, 有大量的研究和实践, 但通常是对于3d游戏而言. 不过近年来3d与2d实现方法结合的2d游戏似乎也越来越流行. 就我之前自己的调研来看, 传统2d, 特别是基于 tilemap 的游戏最常见的做法还是手绘水体 tile, 要更生动一点, 可以做一个 tile 的动画循环播放. 而有一些则在”2d游戏”里使用偏真实的水体渲染. 其实近年来也挺多的, 让我印象深刻的像是风来之国最后夜晚海面演出的那段. 再比如这个<a target="_blank" rel="noopener" href="https://forum.gamemaker.io/index.php?threads/beast-socket-procedural-monsters.36711/">“2d游戏”</a>的水体看起来也非常 nice. jess 的方案也是类似, 通过把3d水体渲染方法进行简化和 Pixel Art 风格化来实现, 这种方法基于纯 shader 实现, 在复用性非常高的同时还让水体有丰富的变化. 而 2d 与 3d 不同的部分(比如没有体积与深度)则需要使用一些特殊方法, 这也是比较有趣的一点. 但反过来说, 这类的分享却非常少看到, 特别是像 jess 如此细腻2d水体的分享.</p>
<p>另一个我觉得需要说明的是水体是一个大类, 海洋, 湖泊, 河流, 瀑布中水的表现是存在差异的. 这也是我觉得这个标题有那么点名不副实的地方. jess 实现的水体其实更接近海洋与湖泊的水体, 特点是运动缓慢, 泛着波光. 而河水通常水流较急, 运动具有明显方向性, 波光也相对规律.</p>
<h2 id="水体的tile"><a href="#水体的tile" class="headerlink" title="水体的tile"></a>水体的tile</h2><p>在具体的 shader 实现前, 必须先提这个方案中水体材质的载体 tilemap. jess 的游戏是基于 tilemap 的, 她使用内部(水体部分)为黑色, 边缘为白色的图块作为水体的 tileset. 如图1是我自己做的水体 tileset. 这里同样可以做成 animate tile, 增加水体伸展的动画. 而 shader 则负责在黑色的部分画出水体效果. 这种制作方式同样有极高的复用性, 只需要更换材质, 不必重新制作 tileset 就可以做出不同的地形表现.</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/water_tile_256x256.png" style="zoom:80%;" class alt="图1" /></p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>在这个 jess 的方案中, 考虑了水体表现的几个部分, 如图2,</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/water_detail.png" style="zoom:80%;" class alt="图2" /></p>
<ol>
<li>海水近岸颜色渐变</li>
</ol>
<p>海水远离沙滩岸边, 随着海水变深, 岸底能见度下降, 海水颜色与沙滩颜色的混合渐变.<br>这是一个非常细节的表现, 其实很少在2d游戏中看到. 同样, 做法也非常地3d, 使用高度图或深度图进行颜色混合. jess 的游戏是一个程序生成地形的开放世界游戏, 所以本身就有这个高度信息. 我自己的实现中不存在这个地形高度, 所以这一条不考虑在内.</p>
<ol>
<li>波纹</li>
</ol>
<p>波纹的表现通常是在水体有相当透明度时出现, 有两个部分, 其一是使用散焦纹理(Caustic Texture)实现波纹底色的部分(图2位置1), 以及在底色基础上增加的高亮(图2位置2), 使水体看起来像是有深度且受光的表现.<br>同时这个波纹有扰动效果, 以及波纹的渐隐渐现, 体现水体的运动.</p>
<ol>
<li>波光</li>
</ol>
<p>即水面模拟受光镜面反射(Specular)的部分(图2位置3).</p>
<ol>
<li>泡沫</li>
</ol>
<p>泡沫(Foam)也是水体重要的部分. 其实严格来说也有好几种, 一种通常称为岸边泡沫, 是海岸与海水分界线上产生的细密泡沫(图2位置4). 另一种是物体在水中, 接触面上产生的交互泡沫. 在 jess 的另一个分享 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=W4eVR_Fm5Gs&amp;t=205s">How I Made Pixel Art Water Trails - Godot Visual Shader</a> 中正分享了她是如何实现交互泡沫的.</p>
<p>大体上就是这些, 在 jess 的分享中似乎还不涉及光影的部分.</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p> 完整的实现水体渲染 shader 如下, 部分函数定义在 pixel_art.hlsl 与 common.hlsl 见附录1.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/PixelWater3&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex(<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;&quot;</span> &#123;&#125;</span><br><span class="line">        _Color(<span class="string">&quot;Color&quot;</span>, Color) = (<span class="number">0</span>, <span class="number">0.57</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        _PPU(<span class="string">&quot;Pixels Per Unit&quot;</span>, Range(<span class="number">1</span>, <span class="number">100</span>)) = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">        _CausticTex(<span class="string">&quot;Caustic Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;&quot;</span> &#123;&#125;</span><br><span class="line">        _CausticColor(<span class="string">&quot;Caustic Color&quot;</span>, Color) = (<span class="number">0</span>, <span class="number">1</span>, <span class="number">0.98</span>, <span class="number">0.12</span>)</span><br><span class="line">        _CausticScale(<span class="string">&quot;Caustic Scale&quot;</span>, Range(<span class="number">0.01</span>, <span class="number">0.1</span>)) = <span class="number">0.08</span></span><br><span class="line">        _CausticSpeed(<span class="string">&quot;Caustic Speed&quot;</span>, Range(<span class="number">0</span>, <span class="number">2</span>)) = <span class="number">0.8</span></span><br><span class="line">        _CausticHighlightTex(<span class="string">&quot;Caustic Highlight Tex&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;&quot;</span> &#123;&#125;</span><br><span class="line">        _CausticHighlightColor(<span class="string">&quot;Caustic Highlight Color&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0.67</span>)</span><br><span class="line">        _CausticNoiseScale(<span class="string">&quot;Caustic Noise Scale&quot;</span>, Range(<span class="number">0</span>, <span class="number">2</span>)) = <span class="number">1.63</span></span><br><span class="line">        _CausticNoiseBlendScale(<span class="string">&quot;Caustic Noise Blend Scale&quot;</span>, Range(<span class="number">0</span>, <span class="number">0.1</span>)) = <span class="number">0.018</span></span><br><span class="line">        _CausticSquash(<span class="string">&quot;Caustic Squash&quot;</span>, Range(<span class="number">0.1</span>, <span class="number">2</span>)) = <span class="number">1.3</span> <span class="comment">// 散焦 y 轴缩放</span></span><br><span class="line">        _CausticFadeNoiseScale(<span class="string">&quot;Caustic Fade Noise Scale&quot;</span>, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.41</span></span><br><span class="line">        _CausticFadeMultiplier(<span class="string">&quot;Caustic Fade Multiplier&quot;</span>, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.12</span></span><br><span class="line"></span><br><span class="line">        _SpecularSpeed(<span class="string">&quot;Specular Speed&quot;</span>, Range(<span class="number">0</span>, <span class="number">2</span>)) = <span class="number">0.3</span></span><br><span class="line">        _SpecularNoiseScale(<span class="string">&quot;Specular Noise Scale&quot;</span>, Range(<span class="number">0.1</span>, <span class="number">2</span>)) = <span class="number">0.83</span></span><br><span class="line">        _SpecularStaticScale(<span class="string">&quot;Specular Static Scale&quot;</span>, Range(<span class="number">0.1</span>, <span class="number">5</span>)) = <span class="number">3.68</span></span><br><span class="line">        _SpecularColor(<span class="string">&quot;Specular Color&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0.87</span>)</span><br><span class="line">        _SpecularThreshold(<span class="string">&quot;Specular Threshold&quot;</span>, Range(<span class="number">-1</span>, <span class="number">1</span>)) = <span class="number">-0.65</span></span><br><span class="line"></span><br><span class="line">        _FoamTex(<span class="string">&quot;Foam Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;&quot;</span> &#123;&#125;</span><br><span class="line">        _FoamColor(<span class="string">&quot;Foam Color&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        _FoamScale(<span class="string">&quot;Foam Scale&quot;</span>, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.5</span></span><br><span class="line">        _FoamBlurScale(<span class="string">&quot;Foam Blur Scale&quot;</span>, Range(<span class="number">0</span>, <span class="number">5</span>)) = <span class="number">3</span></span><br><span class="line">        _FoamTexelSize(<span class="string">&quot;Foam Texel Size&quot;</span>, Range(<span class="number">0</span>, <span class="number">0.01</span>)) = <span class="number">0.003</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 倒影扭曲</span></span><br><span class="line">        _ReflectionNoiseScale(<span class="string">&quot;Reflection Noise Scale&quot;</span>, Range(<span class="number">0</span>, <span class="number">0.1</span>)) = <span class="number">0.01</span></span><br><span class="line">        _ReflectionNoiseBlendScale(<span class="string">&quot;Reflection Noise Blend Scale&quot;</span>, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.2</span></span><br><span class="line">        _ReflectionIntensity(<span class="string">&quot;Reflection Intensity&quot;</span>, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Queue&quot;</span> = <span class="string">&quot;Transparent&quot;</span></span><br><span class="line">            <span class="string">&quot;IgnoreProjector&quot;</span> = <span class="string">&quot;True&quot;</span></span><br><span class="line">            <span class="string">&quot;RenderType&quot;</span> = <span class="string">&quot;Transparent&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZWrite Off</span><br><span class="line">        Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">        Cull Off</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Name <span class="string">&quot;RenderWater&quot;</span></span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line">            <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span></span></span><br><span class="line">            <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Assets/AssetsPackage/Shader/Includes/pixel_art.hlsl&quot;</span></span></span><br><span class="line">            <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Assets/AssetsPackage/Shader/Includes/common.hlsl&quot;</span></span></span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            <span class="type">float</span> _PPU;</span><br><span class="line"></span><br><span class="line">            SamplerState linear_clamp_sampler;</span><br><span class="line">            SamplerState point_clamp_sampler;</span><br><span class="line">            SamplerState point_repeat_sampler;</span><br><span class="line">            SamplerState linear_repeat_sampler;</span><br><span class="line"></span><br><span class="line">            Texture2D _MainTex;</span><br><span class="line">            float4 _Color;</span><br><span class="line">            float4 _MainTex_TexelSize;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 散焦纹理</span></span><br><span class="line">            Texture2D _CausticTex;</span><br><span class="line">            Texture2D _CausticHighlightTex;</span><br><span class="line">            float4 _CausticColor;</span><br><span class="line">            float4 _CausticTex_TexelSize;</span><br><span class="line">            <span class="type">float</span> _CausticScale;</span><br><span class="line">            <span class="type">float</span> _CausticSpeed;</span><br><span class="line">            float4 _CausticHighlightColor;</span><br><span class="line">            <span class="type">float</span> _CausticSquash;</span><br><span class="line">            <span class="comment">// 噪声扰动</span></span><br><span class="line">            <span class="type">float</span> _CausticNoiseScale;</span><br><span class="line">            <span class="type">float</span> _CausticNoiseBlendScale;</span><br><span class="line">            <span class="comment">// 散焦渐隐</span></span><br><span class="line">            <span class="type">float</span> _CausticFadeNoiseScale;</span><br><span class="line">            <span class="type">float</span> _CausticFadeMultiplier;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 高光</span></span><br><span class="line">            <span class="type">float</span> _SpecularSpeed;</span><br><span class="line">            <span class="type">float</span> _SpecularNoiseScale;</span><br><span class="line">            <span class="type">float</span> _SpecularStaticScale;</span><br><span class="line">            float4 _SpecularColor;</span><br><span class="line">            <span class="type">float</span> _SpecularThreshold;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 边缘泡沫</span></span><br><span class="line">            Texture2D _FoamTex;</span><br><span class="line">            float4 _FoamColor;</span><br><span class="line">            <span class="type">float</span> _FoamScale;</span><br><span class="line">            <span class="type">float</span> _FoamBlurScale;</span><br><span class="line">            <span class="type">float</span> _FoamTexelSize;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 倒影</span></span><br><span class="line">            Texture2D _CameraSortingLayerTexture;</span><br><span class="line">            Texture2D _ReflectionTex;</span><br><span class="line">            Texture2D _UnderwaterTex;</span><br><span class="line">            <span class="type">float</span> _ReflectionNoiseScale;</span><br><span class="line">            <span class="type">float</span> _ReflectionNoiseBlendScale;</span><br><span class="line">            <span class="type">float</span> _ReflectionIntensity;</span><br><span class="line">            CBUFFER_END</span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">a2v</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                float4 vertex: POSITION;</span><br><span class="line">                float2 texcoord: TEXCOORD0;</span><br><span class="line">                float4 color: COLOR;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">v2f</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                float4 vertex: SV_POSITION;</span><br><span class="line">                float2 uv: TEXCOORD0;</span><br><span class="line">                float4 color: COLOR;</span><br><span class="line">                float3 world_pos: TEXCOORD1;</span><br><span class="line">                float4 screen_pos: TEXCOORD2;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            v2f <span class="title function_">vert</span><span class="params">(a2v input)</span></span><br><span class="line">            &#123;</span><br><span class="line">                v2f output;</span><br><span class="line">                output.vertex = TransformObjectToHClip(input.vertex.xyz);</span><br><span class="line">                output.uv = input.texcoord;</span><br><span class="line">                output.color = input.color;</span><br><span class="line">                output.world_pos = mul(unity_ObjectToWorld, input.vertex).xyz;</span><br><span class="line">                output.screen_pos = ComputeScreenPos(output.vertex);</span><br><span class="line">                <span class="keyword">return</span> output;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float4 <span class="title function_">frag</span><span class="params">(v2f input)</span> : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">                float3 world_pos = pixelize_world_pos(input.world_pos, _PPU);</span><br><span class="line">                float2 uv = input.uv;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 散焦纹理uv扰动</span></span><br><span class="line">                float2 squash_uv = world_pos.xy * float2(<span class="number">1</span>, _CausticSquash);</span><br><span class="line">                float2 caustic_uv = squash_uv * _CausticScale;</span><br><span class="line">                <span class="type">float</span> caustic_noise = gradient_noise(squash_uv + _Time.y * _CausticSpeed, _CausticNoiseScale);</span><br><span class="line">                float2 caustic_noise_uv = float2(caustic_noise, caustic_noise);</span><br><span class="line">                caustic_uv = blend_subtract(caustic_uv, caustic_noise_uv, _CausticNoiseBlendScale);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 倒影 / 水深</span></span><br><span class="line">                float2 screen_uv = input.screen_pos.xy / input.screen_pos.w;</span><br><span class="line">                screen_uv += caustic_noise_uv * _ReflectionNoiseScale / unity_OrthoParams.y;</span><br><span class="line">                <span class="comment">// float4 screen_col = _CameraSortingLayerTexture.Sample(point_clamp_sampler, clamp(screen_uv + caustic_noise_uv * _ReflectionNoiseScale, 0, 1));</span></span><br><span class="line">                float4 reflection_col = _ReflectionTex.Sample(point_clamp_sampler, screen_uv);</span><br><span class="line">                float4 underwater_col = _UnderwaterTex.Sample(point_clamp_sampler, screen_uv);</span><br><span class="line">                float4 screen_col = lerp(underwater_col, reflection_col, _ReflectionIntensity);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 散焦纹理</span></span><br><span class="line">                float4 caustic_col = _CausticTex.Sample(point_repeat_sampler, caustic_uv) * _CausticColor;</span><br><span class="line">                float4 highlight_col = _CausticHighlightTex.Sample(point_repeat_sampler, caustic_uv) * _CausticHighlightColor;</span><br><span class="line">                caustic_col = lerp(caustic_col, highlight_col, highlight_col.a);</span><br><span class="line">                <span class="comment">// 散焦渐隐</span></span><br><span class="line">                <span class="type">float</span> fade_noise = gradient_noise(input.world_pos.xy, _CausticFadeNoiseScale) * _CausticFadeMultiplier;</span><br><span class="line">                caustic_col.a = clamp(caustic_col.a - fade_noise, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 高光</span></span><br><span class="line">                float2 delta = float2(_Time.y, <span class="number">0</span>) * _SpecularSpeed;</span><br><span class="line">                <span class="type">float</span> noise_left = gradient_noise(world_pos.xy + delta, _SpecularNoiseScale);</span><br><span class="line">                <span class="type">float</span> noise_right = gradient_noise(world_pos.xy - delta, _SpecularNoiseScale);</span><br><span class="line">                <span class="type">float</span> noise_static = gradient_noise(world_pos.xy, _SpecularStaticScale);</span><br><span class="line">                <span class="type">float</span> specular_noise = blend_overlay(noise_left, noise_right, <span class="number">1</span>);</span><br><span class="line">                specular_noise = blend_subtract(specular_noise, noise_static, <span class="number">1</span>);</span><br><span class="line">                float4 specular_col = step(specular_noise, _SpecularThreshold) * _SpecularColor;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 泡沫</span></span><br><span class="line">                float4 foam_col = _FoamTex.Sample(point_repeat_sampler, input.world_pos.xy * _FoamScale) * _FoamColor;</span><br><span class="line">                float4 blur = gaussian_blur_5x5(_MainTex, point_repeat_sampler, uv, float2(_FoamTexelSize, _FoamTexelSize)) * _FoamBlurScale;</span><br><span class="line">                foam_col.a *= blur.r;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 混合 主色, 散焦, 高光, 泡沫, 倒影</span></span><br><span class="line">                caustic_col.rgb = lerp(_Color.rgb, caustic_col.rgb, caustic_col.a);</span><br><span class="line">                caustic_col = lerp(caustic_col, specular_col, <span class="built_in">ceil</span>(caustic_col.a) * specular_col.a);</span><br><span class="line">                caustic_col = lerp(caustic_col, foam_col, foam_col.a);</span><br><span class="line">                caustic_col = lerp(caustic_col, screen_col, screen_col.a * _ReflectionNoiseBlendScale);</span><br><span class="line"></span><br><span class="line">                uv = pixelize_uv(uv, _MainTex_TexelSize);</span><br><span class="line">                float4 col = _MainTex.Sample(point_clamp_sampler, uv);</span><br><span class="line">                foam_col = _FoamColor * (col.r * col.a); <span class="comment">// 复用 foam_col 变量</span></span><br><span class="line">                col.rgb = lerp(caustic_col.rgb, foam_col.rgb, col.r * col.a);</span><br><span class="line">                col.a = col.a * _Color.a;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> col;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分块简单解释一下</p>
<ul>
<li>产生散焦贴图uv扰动</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">float2 squash_uv = world_pos.xy * float2(<span class="number">1</span>, _CausticSquash);</span><br><span class="line">float2 caustic_uv = squash_uv * _CausticScale;</span><br><span class="line"><span class="type">float</span> caustic_noise = gradient_noise(squash_uv + _Time.y * _CausticSpeed, _CausticNoiseScale);</span><br><span class="line">float2 caustic_noise_uv = float2(caustic_noise, caustic_noise);</span><br><span class="line">caustic_uv = blend_subtract(caustic_uv, caustic_noise_uv, _CausticNoiseBlendScale);</span><br></pre></td></tr></table></figure>
<p>这里使用世界坐标加扰动来生成采样散焦纹理(<code>_CausticTex</code>)的uv坐标. 使用 <code>_CausticSquash</code> 对竖直方向进行缩放, 以用模拟斜视水面的效果. gradient_noise 用于产生扰动uv所需的柏林噪声(Perlin Noise), 其定义见附录1.</p>
<ul>
<li>倒影与水深</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 倒影 / 水深</span></span><br><span class="line">float2 screen_uv = input.screen_pos.xy / input.screen_pos.w;</span><br><span class="line">screen_uv += caustic_noise_uv * _ReflectionNoiseScale / unity_OrthoParams.y;</span><br><span class="line"><span class="comment">// float4 screen_col = _CameraSortingLayerTexture.Sample(point_clamp_sampler, clamp(screen_uv + caustic_noise_uv * _ReflectionNoiseScale, 0, 1));</span></span><br><span class="line">float4 reflection_col = _ReflectionTex.Sample(point_clamp_sampler, screen_uv);</span><br><span class="line">float4 underwater_col = _UnderwaterTex.Sample(point_clamp_sampler, screen_uv);</span><br><span class="line">float4 screen_col = lerp(underwater_col, reflection_col, _ReflectionIntensity);</span><br></pre></td></tr></table></figure>
<p>在这个实现方案中, 倒影(<code>_ReflectionTex</code>)与水深(<code>_UnderwaterTex</code>)有两个单独的渲染纹理(RT, Render Texture), 在渲染水体时进行采样, RT的生成参考倒影与水深实现方案一节. <code>_ReflectionIntensity</code> 用于控制两者混合的权重. 我感觉通常倒影和水深的效果只需取其一, 否则混合后重叠看着有点乱.</p>
<ul>
<li>散焦纹理采样</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 散焦纹理</span></span><br><span class="line">float4 caustic_col = _CausticTex.Sample(point_repeat_sampler, caustic_uv) * _CausticColor;</span><br><span class="line">float4 highlight_col = _CausticHighlightTex.Sample(point_repeat_sampler, caustic_uv) * _CausticHighlightColor;</span><br><span class="line">caustic_col = lerp(caustic_col, highlight_col, highlight_col.a);</span><br><span class="line"><span class="comment">// 散焦渐隐</span></span><br><span class="line"><span class="type">float</span> fade_noise = gradient_noise(input.world_pos.xy, _CausticFadeNoiseScale) * _CausticFadeMultiplier;</span><br><span class="line">caustic_col.a = clamp(caustic_col.a - fade_noise, <span class="number">0</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>这里有散焦底色的纹理(<code>_CausticTex</code>)与高亮的纹理(<code>_CausticHighlightTex</code>), 后者由前者图像处理腐蚀后生成, 保证了高亮的部分一定在底色的纹理之上, 看起来就像是部分波纹变成了高亮. 同时用柏林噪声增加了散焦纹理部分渐隐效果.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 高光</span></span><br><span class="line">float2 delta = float2(_Time.y, <span class="number">0</span>) * _SpecularSpeed;</span><br><span class="line"><span class="type">float</span> noise_left = gradient_noise(world_pos.xy + delta, _SpecularNoiseScale);</span><br><span class="line"><span class="type">float</span> noise_right = gradient_noise(world_pos.xy - delta, _SpecularNoiseScale);</span><br><span class="line"><span class="type">float</span> noise_static = gradient_noise(world_pos.xy, _SpecularStaticScale);</span><br><span class="line"><span class="type">float</span> specular_noise = blend_overlay(noise_left, noise_right, <span class="number">1</span>);</span><br><span class="line">specular_noise = blend_subtract(specular_noise, noise_static, <span class="number">1</span>);</span><br><span class="line">float4 specular_col = step(specular_noise, _SpecularThreshold) * _SpecularColor;</span><br></pre></td></tr></table></figure>
<p>高光的部分使用2个反向运动的柏林噪声与一个静态的柏林噪声混合生成. </p>
<ul>
<li>泡沫</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泡沫</span></span><br><span class="line">float4 foam_col = _FoamTex.Sample(point_repeat_sampler, input.world_pos.xy * _FoamScale) * _FoamColor;</span><br><span class="line">float4 blur = gaussian_blur_5x5(_MainTex, point_repeat_sampler, uv, float2(_FoamTexelSize, _FoamTexelSize)) * _FoamBlurScale;</span><br><span class="line">foam_col.a *= blur.r;</span><br></pre></td></tr></table></figure>
<p>这里 <code>_FoamTex</code> 泡沫贴图是散焦贴图缩放后得到的, 用于表现细小的岸边泡沫. 不同于3d中使用深度确定泡沫显示范围, jess 的方案使用高斯模糊使白色边缘具有渐变效果, 然后与泡沫纹理混合. <code>gaussian_blur_5x5</code> 的定义见附录1.</p>
<p>高斯模糊 + tilemap 会有一个隐含的坑点. 说来话长, 我把这个话题放到附录2中讨论. 其实可以预先在 tileset 中就处理好渐变, 这样可以省去高斯模糊这一步, 我看到 jess 后续的分享似乎也改变了泡沫的实现方法.</p>
<ul>
<li>混合以上所有颜色</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 混合 主色, 散焦, 高光, 泡沫, 倒影</span></span><br><span class="line">caustic_col.rgb = lerp(_Color.rgb, caustic_col.rgb, caustic_col.a);</span><br><span class="line">caustic_col = lerp(caustic_col, specular_col, <span class="built_in">ceil</span>(caustic_col.a) * specular_col.a);</span><br><span class="line">caustic_col = lerp(caustic_col, foam_col, foam_col.a);</span><br><span class="line">caustic_col = lerp(caustic_col, screen_col, screen_col.a * _ReflectionNoiseBlendScale);</span><br><span class="line"></span><br><span class="line">uv = pixelize_uv(uv, _MainTex_TexelSize);</span><br><span class="line">float4 col = _MainTex.Sample(point_clamp_sampler, uv);</span><br><span class="line">foam_col = _FoamColor * (col.r * col.a); <span class="comment">// 复用 foam_col 变量</span></span><br><span class="line">col.rgb = lerp(caustic_col.rgb, foam_col.rgb, col.r * col.a);</span><br><span class="line">col.a = col.a * _Color.a;</span><br></pre></td></tr></table></figure>
<p><code>pixelize_uv</code> 的定义见附录1, 原理可以参考这篇文章<a href="https://granvallen.github.io/PixelArtUpscaling/">浅谈Pixel Art缩放及抗锯齿问题 | Granvallen;Nest</a>.<br>以上从我自己测试来看, 相同参数下, 水体表现和 jess 的实现基本一致. shader 中所用到的3张贴图(<code>_CausticTex</code>, <code>_CausticHighlightTex</code> 和 <code>_FoamTex</code>)都来自 jess 的示例工程, 实现效果如图3,</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/pixel_water_4.gif" style="zoom:80%;" class alt="图3" /></p>
<p>调整部分参数的效果变化如图4,</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/pixel_water_3.gif" style="zoom:80%;" class alt="图4" /></p>
<h1 id="2d水体的倒影与水深"><a href="#2d水体的倒影与水深" class="headerlink" title="2d水体的倒影与水深"></a>2d水体的倒影与水深</h1><p>在我少量的调研中, 那些使用3d技术的2d游戏中, 为了表现水的真实, 大多都实现了这类效果, 特别是水深的效果. 而在纯2d游戏中也有少部分实现了简单的黑色模糊倒影效果, 水深则较为少见.</p>
<p>说是2d, 其实2d的游戏表现方式五花八门, 最常见的有横版平台跳跃, 类似 jess 这个游戏的正面(Top-down)视角, 以及2d等距视角(Isometric), 这里只讨论正面 Top-down 视角的情况. 关于这个视角, 突然想起王老菊有个视频很有意思<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ft411A74o/">未来科技开发日记#1</a>.</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p>尝试寻找解决方案之前, 先考虑下这个问题最复杂的情况, 如果能处理好复杂的情况, 那更通常的情况应该也是ok的. 比如一个复杂的情况是, 一个有一半没入水中的动态物体在水的边缘处. 这种情况会同时出现动态的倒影与水深, 以及倒影和水深在水不规则边缘的处理. </p>
<p>一种2d倒影简单且广泛采用的实现思路是物体的倒影是单独贴图, 事先做好, 控制渲染顺序, 先渲染出倒影, 然后渲染水体时抓取屏幕贴图, 对水体范围的颜色进行叠加和扰动. 比如这个分享中的做法 <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1364y1X7NZ/">UnityShader实现2D水面及物体水面投影的渲染</a>.</p>
<p>显然这个思路是可行的, 但对于稍复杂的情况就暴露出一些问题, 需要进一步改进. 比如,</p>
<ul>
<li>因为是独立的贴图, 所以对于静态物体是比较好处理的, 但是如果贴图本身会动, 像是角色有序列帧动画, 就需要额外处理倒影贴图的变化, 这个就不太方便.</li>
<li>因为是先渲染的倒影, 渲染出来后屏幕才能抓到帧进行水体表现效果, 而如果物体在水边缘, 露出来的部分倒影就会穿帮. 期望应该是倒影只会在水体内渲染.</li>
<li>如果想处理地更精细一点, 单独控制倒影与水深的强度, 简单的抓帧显然是做不到的.</li>
</ul>
<p>我初期尝试对这种方案进行修补, 但最终放弃了. 这里 URP 2D 渲染管线 + 屏幕抓帧也有很多坑, 如果有人采用这个方案我简单提一嘴碰到的问题. URP 中无法使用 Build-in 管线中 GrabPass 进行屏幕抓帧, 而是需要在 Render Pipeline Asset 检视界面中勾选 Opaque Texture, 这样屏幕贴图会自动渲染到一个内置的全局RT <code>_CameraOpaqueTexture</code> 中, 在 shader 中采样这个RT即可. 而如果你使用 URP 2D 管线, 那么这个方法也是失效的, 你需要单独设置一个 layer 和在 Render Data 检视界面中新增 Render Object 来进行屏幕贴图的渲染, 然后使用 <code>_CameraSortingLayerTexture</code> 进行采样, 这种做法目前有很多局限, 可以参考这个讨论 <a target="_blank" rel="noopener" href="https://discussions.unity.com/t/is-it-possible-to-have-transparents-using-the-2d-renderer-in-urp/772498/38">Is it possible to have transparents using the 2D renderer in URP? - Unity Engine - Unity Discussions</a>.</p>
<p>如果沿用这个屏幕空间反射的2d倒影实现思路, 对于上面要解决的问题可以简单总结为</p>
<ol>
<li>倒影/水深贴图怎么获取?</li>
<li>怎么只在水体范围内渲染这些贴图内容?</li>
</ol>
<p>对于第一个倒影贴图怎么来的问题, 如果要精细控制还是需要倒影与水深分开获取. 对于倒影, 需要能实时地渲染出物体的动态倒影, 这个也有几种方案, 像是屏幕空间上下倒转, 物体贴图的倒转. 水深与倒影的处理类似, 只是不需要进行倒转操作.</p>
<p>对于第二个问题, 倒影只出现在水体范围内, 大致有两种做法, 一是使用模板缓冲(Stencil Buffer), 水体渲染需要两个 pass, 第一个 pass 渲染水体时只写入模板缓存, 然后渲染倒影/水深时读取模板, 最后水体第二个 pass 读取倒影渲染结果再混合渲染水体颜色. 然而 URP 似乎不支持多 pass 的 shader, 只能作罢. 模板匹配的另一个麻烦之处在于水边缘处理, 如果边缘是不规则的, 就需要根据透明度的情况处理模板缓存.</p>
<p>另一种做法则更直接, 把倒影与水深渲染到单独RT上, 而主相机中不对其进行渲染, 然后水体渲染时读取RT进行混合. 这个方案使用自定义的 Renderer Featuer 可以很容易做到.</p>
<p>于是我想到一种简单可行, 且统一反射与水深的方案. 给每个入水物体节点再挂两个 Sprite 节点, 一个设置为倒影层用于渲染倒影, 一个设置为水深层渲染水深, 每帧把主 Sprite 的贴图更新到这两个子 Sprite 上, 而这两个 Sprite Renderer 各自使用单独的 shader 渲染自己的贴图, shader 的参数也可以直接在更新时赋值. 只需要这两个 Sprite 设置为不同的 Layer 比如反射层(Reflection) 与 水深层(Underwater), 借助自定义 Renderer Feature 就可以渲染出这两个单独的RT.</p>
<p>光这样还不够, 还需要实现一个特殊的 Sprite 分割 shader, 外部脚本可以传参数进去, 一个参数决定 Sprite 在 y 方向上显示的分割线, 另一个参数决定是分割线以上还是以下的部分显示, 这样就可以模拟出 Sprite 没入水中的效果.</p>
<h2 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h2><p>自定义的 Renderer Feature 与 Render Pass 代码如下,<br><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine.Rendering.Universal;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenderLayerFeature</span> : <span class="title">ScriptableRendererFeature</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> RenderLayerPass _pass;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> LayerMask layer_mask;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> rt_name = <span class="string">&quot;_TempRenderLayer&quot;</span>;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> RenderPassEvent pass_event = RenderPassEvent.BeforeRenderingOpaques;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> TransparencySortMode sort_mode = TransparencySortMode.Default;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> Vector3 custom_axis = Vector3.up;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Create</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _pass = <span class="keyword">new</span> RenderLayerPass(layer_mask, rt_name, pass_event, sort_mode, custom_axis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRenderPasses</span>(<span class="params">ScriptableRenderer renderer, <span class="keyword">ref</span> RenderingData rendering_data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _pass.Setup();</span><br><span class="line">        renderer.EnqueuePass(_pass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine.Rendering.Universal;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenderLayerPass</span> : <span class="title">ScriptableRenderPass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> RenderTargetHandle rt_handle;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> rt_name;</span><br><span class="line">    <span class="keyword">private</span> ShaderTagId shader_tag_id = <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;SRPDefaultUnlit&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> FilteringSettings filtering_settings;</span><br><span class="line">    <span class="keyword">private</span> LayerMask layer_mask;</span><br><span class="line">    <span class="keyword">private</span> TransparencySortMode sort_mode;</span><br><span class="line">    <span class="keyword">private</span> Vector3 custom_axis;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RenderLayerPass</span>(<span class="params">LayerMask layer_mask, <span class="built_in">string</span> rt_name, RenderPassEvent pass_event, TransparencySortMode sort_mode, Vector3 custom_axis</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.layer_mask = layer_mask;</span><br><span class="line">        <span class="keyword">this</span>.rt_name = rt_name;</span><br><span class="line">        <span class="keyword">this</span>.sort_mode = sort_mode;</span><br><span class="line">        <span class="keyword">this</span>.custom_axis = custom_axis;</span><br><span class="line">        renderPassEvent = pass_event; <span class="comment">// 设置渲染时机</span></span><br><span class="line"></span><br><span class="line">        filtering_settings = <span class="keyword">new</span> FilteringSettings(RenderQueueRange.all, layer_mask);</span><br><span class="line">        rt_handle.Init(rt_name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Setup</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">CommandBuffer cmd, RenderTextureDescriptor cameraTextureDescriptor</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        RenderTextureDescriptor rt_desc = cameraTextureDescriptor; <span class="comment">// RenderTexture 描述符</span></span><br><span class="line"></span><br><span class="line">        cmd.GetTemporaryRT(rt_handle.id, rt_desc.width, rt_desc.height, <span class="number">0</span>, FilterMode.Bilinear, RenderTextureFormat.ARGBHalf); <span class="comment">// 临时 RT</span></span><br><span class="line">        cmd.SetGlobalTexture(rt_name, rt_handle.Identifier()); <span class="comment">// 设置全局纹理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置渲染目标和清除设置</span></span><br><span class="line">        ConfigureTarget(rt_handle.Identifier());</span><br><span class="line">        ConfigureClear(ClearFlag.All, Color.clear);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">ScriptableRenderContext context, <span class="keyword">ref</span> RenderingData rendering_data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 手动创建剔除参数</span></span><br><span class="line">        Camera camera = rendering_data.cameraData.camera;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须设置, 否则倒影渲染顺序会有问题</span></span><br><span class="line">        camera.transparencySortMode = sort_mode;</span><br><span class="line">        camera.transparencySortAxis = custom_axis;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!camera.TryGetCullingParameters(<span class="keyword">out</span> ScriptableCullingParameters culling_params))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置剔除遮罩</span></span><br><span class="line">        culling_params.cullingMask = (<span class="built_in">uint</span>)layer_mask.<span class="keyword">value</span>;</span><br><span class="line">        CullingResults culling_results = context.Cull(<span class="keyword">ref</span> culling_params);</span><br><span class="line">        DrawingSettings draw_settings = CreateDrawingSettings(</span><br><span class="line">            shader_tag_id, </span><br><span class="line">            <span class="keyword">ref</span> rendering_data, </span><br><span class="line">            SortingCriteria.SortingLayer | SortingCriteria.CommonTransparent</span><br><span class="line">        );</span><br><span class="line">        context.DrawRenderers(culling_results, <span class="keyword">ref</span> draw_settings, <span class="keyword">ref</span> filtering_settings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">FrameCleanup</span>(<span class="params">CommandBuffer cmd</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        cmd.ReleaseTemporaryRT(rt_handle.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 RenderLayerFeature 实现的功能非常简单, 就是把特定 Layer 的内容渲染到一个自命名的全局RT里, 可以在 Render Data 资源检视界面里创建两个实例分别渲染物体的倒影层(<code>_ReflectionTex</code>)与水深层(<code>_UnderwaterTex</code>).</p>
<p>至于入水物体 shader 的实现, 这就不得不提到 Sprite Renderer 的一个坑点.</p>
<h2 id="水中物体处理与Sprite合批"><a href="#水中物体处理与Sprite合批" class="headerlink" title="水中物体处理与Sprite合批"></a>水中物体处理与Sprite合批</h2><p>在前面提到的实现思路中, 水中物体需要一个分割 Sprite 的 shader, 一种实现如下,<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">v2f <span class="title function_">vert</span><span class="params">(a2v input)</span></span><br><span class="line">&#123;</span><br><span class="line">	v2f output;</span><br><span class="line">	input.vertex.y -= _OffsetY; <span class="comment">// 竖直移动</span></span><br><span class="line">	output.local_pos = input.vertex;</span><br><span class="line">	output.vertex = TransformObjectToHClip(input.vertex.xyz);</span><br><span class="line">	output.uv = input.texcoord;</span><br><span class="line">	output.color = input.color * _Color;</span><br><span class="line">	<span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 <span class="title function_">frag</span><span class="params">(v2f input)</span> : SV_Target</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// sprite 剔除</span></span><br><span class="line">	<span class="type">float</span> is_discard = _Upper * input.local_pos.y + (<span class="number">1.0</span> / _PPU - input.local_pos.y) * (<span class="number">1</span> - _Upper);</span><br><span class="line">	clip(is_discard);</span><br><span class="line"></span><br><span class="line">	float2 uv = pixelize_uv(input.uv, _MainTex_TexelSize);</span><br><span class="line">	float4 col = _MainTex.Sample(linear_clamp_sampler, uv);</span><br><span class="line">	<span class="keyword">return</span> col * input.color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在顶点着色器中移动并缓存下物体偏移后的局部坐标, 然后在片元着色器中进行剔除.</p>
<p>当场景中该物体只有一个时表现符合期望, 但当场景中有两个以上的相同物体时, Sprite 的渲染就会出现问题, 看表现像是 shader 中的局部坐标不再可靠. 检索之后才知道 Sprite Renderer 会自带一个动态合批处理(与工程本身合批配置无关), 当场景中有多个相同 Sprite 且材质相同时, 就会触发这个幕后的动态合批, 进行网格合并操作, 以便同时绘制多个Sprite. 但这导致 shader 中上述局部空间坐标的失效, 参考,</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://discussions.unity.com/t/how-to-prevent-sprite-batching-or-display-sprites-without-using-sprite-renderer/805269/4">How to prevent sprite batching OR display sprites without using sprite renderer? - Unity Engine - Unity Discussions</a></li>
<li><a target="_blank" rel="noopener" href="https://discussions.unity.com/t/how-to-get-an-absolute-object-space-position-when-draw-calls-are-batched/831888">How to get an absolute object-space position when draw calls are batched? - Unity Engine - Unity Discussions</a></li>
</ul>
<p>解决方法是在 shader 中加个禁止 batching 的 tag,<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;DisableBatching&quot;</span> = <span class="string">&quot;True&quot;</span></span><br></pre></td></tr></table></figure><br>这能解决表现的问题, 不过代价是所有物体都需要单独进行绘制. 进一步检索之后发现, Sprite Renderer 在合批流程中的支持一直不太好, 原生不支持常见的合批方法, 而其自带的动态合批在使用不同的 Sprite 时也没办法合批(似乎是Sprite Renderer 针对不同的 Sprite 会生成不同的网格). 参考</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://discussions.unity.com/t/batching-and-sprite-renderers/792099/8">Batching and Sprite Renderers - Unity Engine - Unity Discussions</a></li>
<li><a target="_blank" rel="noopener" href="https://discussions.unity.com/t/srp-batcher-spriterenderer/918871">SRP Batcher &amp; SpriteRenderer - Unity Engine - Unity Discussions</a></li>
</ul>
<p>似乎 unity 2023 版本 Sprite Renderer 才支持了 SRP Batcher.</p>
<p>不过好在已经有人探索过相关的解决方案了, 比如</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.ownself.org/2022/unity-sprite-gpu-instancing.html">为Unity Sprite实现GPU Instancing</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ownself/UnitySpriteGPUInstancing">GitHub - ownself/UnitySpriteGPUInstancing: A Unity Sprite GPU Instancing Implementation Demo</a></li>
</ul>
<p>从这个分享中看, 我猜铃兰之剑似乎也使用了类似的方案. 思路是自己创建管理相同的渲染网格, 用 Mesh Renderer 代替 Sprite Renderer 进行渲染, 而这个流程支持 GPU Instancing, 可以说是一个相当优雅的解决方案了. 那么问题就由创建 Sprite, 变成创建 Mesh. 处理后我们可以在 frame debuger 中看到, 所有物体是由单个批次绘制的. 物体挂载脚本 MapObjectRenerer.cs 与物体 shader mapobject.shader 实现如下,</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">[<span class="meta">RequireComponent(typeof(SpriteRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectRenderer</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> SpriteRenderer _sprite_renderer;</span><br><span class="line">    <span class="keyword">private</span> MaterialPropertyBlock _prop_block;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _tex_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Vector4 _pivot;</span><br><span class="line">    <span class="keyword">private</span> Vector4 _uv;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> _ppu = <span class="number">32f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> offset_y = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sprite mesh</span></span><br><span class="line">    <span class="keyword">private</span> GameObject _sprite_mesh_go;</span><br><span class="line">    <span class="keyword">private</span> MeshRenderer _sprite_mesh_renderer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reflection mesh</span></span><br><span class="line">    <span class="keyword">private</span> GameObject _reflection_mesh_go;</span><br><span class="line">    <span class="keyword">private</span> MeshRenderer _reflection_mesh_renderer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// underwater mesh</span></span><br><span class="line">    <span class="keyword">private</span> GameObject _underwater_mesh_go;</span><br><span class="line">    <span class="keyword">private</span> MeshRenderer _underwater_mesh_renderer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 静态变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Mesh _mesh;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;Texture2D, <span class="built_in">int</span>&gt; tex_indexes = <span class="keyword">new</span> Dictionary&lt;Texture2D, <span class="built_in">int</span>&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> array_size = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Texture2DArray tex_array;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> tex_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _sprite_renderer = GetComponent&lt;SpriteRenderer&gt;();</span><br><span class="line">        _sprite_renderer.enabled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        _ppu = _sprite_renderer.sprite.pixelsPerUnit;</span><br><span class="line">        Texture2D tex = _sprite_renderer.sprite.texture; <span class="comment">// tex 是 sprite sheet</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tex_array == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            tex_array = <span class="keyword">new</span> Texture2DArray(tex.width, tex.height, array_size, tex.format, <span class="literal">false</span>);</span><br><span class="line">            tex_count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_prop_block == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _prop_block = <span class="keyword">new</span> MaterialPropertyBlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!tex_indexes.ContainsKey(tex))</span><br><span class="line">        &#123;</span><br><span class="line">            Graphics.CopyTexture(tex, <span class="number">0</span>, <span class="number">0</span>, tex_array, tex_count, <span class="number">0</span>);</span><br><span class="line">            _tex_index = tex_count;</span><br><span class="line">            tex_indexes[tex] = _tex_index;</span><br><span class="line">            tex_count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _tex_index = tex_indexes[tex];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_mesh == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _mesh = create_mesh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        create_sprite_mesh();</span><br><span class="line">        create_reflection_mesh();</span><br><span class="line">        create_underwater_mesh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        update_mesh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mesh <span class="title">create_mesh</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Mesh mesh = <span class="keyword">new</span> Mesh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义顶点，枢轴位于底部中心</span></span><br><span class="line">        Vector3[] vertices = <span class="keyword">new</span> Vector3[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> Vector3(<span class="number">-1f</span>, <span class="number">0f</span>, <span class="number">0</span>), <span class="comment">// 左下</span></span><br><span class="line">            <span class="keyword">new</span> Vector3(<span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0</span>),  <span class="comment">// 右下</span></span><br><span class="line">            <span class="keyword">new</span> Vector3(<span class="number">-1f</span>, <span class="number">2f</span>, <span class="number">0</span>), <span class="comment">// 左上</span></span><br><span class="line">            <span class="keyword">new</span> Vector3(<span class="number">1f</span>, <span class="number">2f</span>, <span class="number">0</span>)   <span class="comment">// 右上</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义 UV</span></span><br><span class="line">        Vector2[] uvs = <span class="keyword">new</span> Vector2[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="keyword">new</span> Vector2(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> Vector2(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义三角形</span></span><br><span class="line">        <span class="built_in">int</span>[] triangles = <span class="keyword">new</span> <span class="built_in">int</span>[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>,</span><br><span class="line">            <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        mesh.vertices = vertices;</span><br><span class="line">        mesh.uv = uvs;</span><br><span class="line">        mesh.triangles = triangles;</span><br><span class="line">        mesh.RecalculateNormals();</span><br><span class="line">        mesh.RecalculateBounds();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mesh;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新 pivot uv 变量</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">update_pivot_uv</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Sprite sprite = _sprite_renderer.sprite;</span><br><span class="line"></span><br><span class="line">        _pivot.x = sprite.rect.width * <span class="number">0.5f</span> / sprite.pixelsPerUnit;</span><br><span class="line">        _pivot.y = sprite.rect.height * <span class="number">0.5f</span> / sprite.pixelsPerUnit;</span><br><span class="line">        _pivot.z = (sprite.rect.width * <span class="number">0.5f</span> - sprite.pivot.x) / sprite.pixelsPerUnit;</span><br><span class="line">        _pivot.w = sprite.pivot.y / sprite.pixelsPerUnit;</span><br><span class="line"></span><br><span class="line">        _uv.x = sprite.uv[<span class="number">1</span>].x - sprite.uv[<span class="number">0</span>].x;</span><br><span class="line">        _uv.y = sprite.uv[<span class="number">0</span>].y - sprite.uv[<span class="number">2</span>].y;</span><br><span class="line">        _uv.z = sprite.uv[<span class="number">2</span>].x;</span><br><span class="line">        _uv.w = sprite.uv[<span class="number">2</span>].y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">create_sprite_mesh</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_sprite_mesh_go != <span class="literal">null</span>)</span><br><span class="line">            DestroyImmediate(_sprite_mesh_go);</span><br><span class="line"></span><br><span class="line">        _sprite_mesh_go = <span class="keyword">new</span> GameObject(<span class="string">&quot;sprite_mesh&quot;</span>);</span><br><span class="line">        _sprite_mesh_go.layer = gameObject.layer;</span><br><span class="line">        _sprite_mesh_go.transform.SetParent(transform);</span><br><span class="line">        _sprite_mesh_go.transform.localPosition = Vector3.zero;</span><br><span class="line">        _sprite_mesh_go.transform.localRotation = Quaternion.identity;</span><br><span class="line">        _sprite_mesh_go.transform.localScale = Vector3.one;</span><br><span class="line"></span><br><span class="line">        MeshFilter mesh_filter = _sprite_mesh_go.AddComponent&lt;MeshFilter&gt;();</span><br><span class="line">        mesh_filter.sharedMesh = _mesh;</span><br><span class="line"></span><br><span class="line">        _sprite_mesh_renderer = _sprite_mesh_go.AddComponent&lt;MeshRenderer&gt;();</span><br><span class="line">        _sprite_mesh_renderer.enabled = <span class="literal">true</span>;</span><br><span class="line">        _sprite_mesh_renderer.sortingLayerID = _sprite_renderer.sortingLayerID;</span><br><span class="line">        _sprite_mesh_renderer.sortingOrder = _sprite_renderer.sortingOrder;</span><br><span class="line">        _sprite_mesh_renderer.sharedMaterial = ResMgr.instance.load_material(<span class="string">&quot;Material/mapobject.mat&quot;</span>);</span><br><span class="line">        _sprite_mesh_renderer.sharedMaterial.SetTexture(<span class="string">&quot;_Textures&quot;</span>, tex_array);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">create_reflection_mesh</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_reflection_mesh_go != <span class="literal">null</span>)</span><br><span class="line">            DestroyImmediate(_reflection_mesh_go);</span><br><span class="line"></span><br><span class="line">        _reflection_mesh_go = <span class="keyword">new</span> GameObject(<span class="string">&quot;reflection_mesh&quot;</span>);</span><br><span class="line">        _reflection_mesh_go.layer = LayerMask.NameToLayer(<span class="string">&quot;Reflection&quot;</span>);</span><br><span class="line">        _reflection_mesh_go.transform.SetParent(transform);</span><br><span class="line">        _reflection_mesh_go.transform.localPosition = Vector3.zero;</span><br><span class="line">        _reflection_mesh_go.transform.localRotation = Quaternion.identity;</span><br><span class="line">        _reflection_mesh_go.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        MeshFilter mesh_filter = _reflection_mesh_go.AddComponent&lt;MeshFilter&gt;();</span><br><span class="line">        mesh_filter.sharedMesh = _mesh;</span><br><span class="line"></span><br><span class="line">        _reflection_mesh_renderer = _reflection_mesh_go.AddComponent&lt;MeshRenderer&gt;();</span><br><span class="line">        _reflection_mesh_renderer.enabled = <span class="literal">true</span>;</span><br><span class="line">        _reflection_mesh_renderer.sharedMaterial = ResMgr.instance.load_material(<span class="string">&quot;Material/mapobject.mat&quot;</span>);</span><br><span class="line">        _reflection_mesh_renderer.sharedMaterial.SetTexture(<span class="string">&quot;_Textures&quot;</span>, tex_array);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">create_underwater_mesh</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_underwater_mesh_go != <span class="literal">null</span>)</span><br><span class="line">            DestroyImmediate(_underwater_mesh_go);</span><br><span class="line"></span><br><span class="line">        _underwater_mesh_go = <span class="keyword">new</span> GameObject(<span class="string">&quot;underwater_mesh&quot;</span>);</span><br><span class="line">        _underwater_mesh_go.layer = LayerMask.NameToLayer(<span class="string">&quot;Underwater&quot;</span>);</span><br><span class="line">        _underwater_mesh_go.transform.SetParent(transform);</span><br><span class="line">        _underwater_mesh_go.transform.localPosition = Vector3.zero;</span><br><span class="line">        _underwater_mesh_go.transform.localRotation = Quaternion.identity;</span><br><span class="line">        _underwater_mesh_go.transform.localScale = Vector3.one;</span><br><span class="line"></span><br><span class="line">        MeshFilter mesh_filter = _underwater_mesh_go.AddComponent&lt;MeshFilter&gt;();</span><br><span class="line">        mesh_filter.sharedMesh = _mesh;</span><br><span class="line"></span><br><span class="line">        _underwater_mesh_renderer = _underwater_mesh_go.AddComponent&lt;MeshRenderer&gt;();</span><br><span class="line">        _underwater_mesh_renderer.enabled = <span class="literal">true</span>;</span><br><span class="line">        _underwater_mesh_renderer.sharedMaterial = ResMgr.instance.load_material(<span class="string">&quot;Material/mapobject.mat&quot;</span>);</span><br><span class="line">        _underwater_mesh_renderer.sharedMaterial.SetTexture(<span class="string">&quot;_Textures&quot;</span>, tex_array);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">update_mesh</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        update_pivot_uv();</span><br><span class="line"></span><br><span class="line">        _sprite_mesh_renderer.GetPropertyBlock(_prop_block);</span><br><span class="line">        _prop_block.SetFloat(<span class="string">&quot;_PPU&quot;</span>, _ppu);</span><br><span class="line">        _prop_block.SetFloat(<span class="string">&quot;_TexIndex&quot;</span>, _tex_index);</span><br><span class="line">        _prop_block.SetVector(<span class="string">&quot;_Pivot&quot;</span>, _pivot);</span><br><span class="line">        _prop_block.SetVector(<span class="string">&quot;_UV&quot;</span>, _uv);</span><br><span class="line">        _prop_block.SetFloat(<span class="string">&quot;_Upper&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        _prop_block.SetFloat(<span class="string">&quot;_OffsetY&quot;</span>, offset_y);</span><br><span class="line">        _sprite_mesh_renderer.SetPropertyBlock(_prop_block);</span><br><span class="line"></span><br><span class="line">        _reflection_mesh_renderer?.SetPropertyBlock(_prop_block);</span><br><span class="line"></span><br><span class="line">        _prop_block.SetFloat(<span class="string">&quot;_Upper&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        _underwater_mesh_renderer?.SetPropertyBlock(_prop_block);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/MapObject2&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _Color(<span class="string">&quot;Color&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        _Textures(<span class="string">&quot;Textures&quot;</span>, <span class="number">2</span>DArray) = <span class="string">&quot;&quot;</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Queue&quot;</span> = <span class="string">&quot;Transparent&quot;</span></span><br><span class="line">            <span class="string">&quot;IgnoreProjector&quot;</span> = <span class="string">&quot;True&quot;</span></span><br><span class="line">            <span class="string">&quot;RenderType&quot;</span> = <span class="string">&quot;Opaque&quot;</span></span><br><span class="line">            <span class="string">&quot;PreviewType&quot;</span> = <span class="string">&quot;Plane&quot;</span></span><br><span class="line">            <span class="string">&quot;CanUseSpriteAtlas&quot;</span> = <span class="string">&quot;True&quot;</span></span><br><span class="line">            <span class="comment">// &quot;DisableBatching&quot;=&quot;True&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZWrite Off</span><br><span class="line">        Lighting Off</span><br><span class="line">        Cull Off</span><br><span class="line">        Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">        </span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> require 2darray</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> multi_compile_instancing</span></span><br><span class="line">            <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span></span></span><br><span class="line">            <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Assets/AssetsPackage/Shader/Includes/pixel_art.hlsl&quot;</span></span></span><br><span class="line"></span><br><span class="line">            Texture2DArray _Textures;</span><br><span class="line">            SamplerState linear_clamp_sampler;</span><br><span class="line">            SamplerState point_clamp_sampler;</span><br><span class="line">            float4 _Textures_TexelSize;</span><br><span class="line">            float4 _Color;</span><br><span class="line"></span><br><span class="line">            UNITY_INSTANCING_BUFFER_START(Props)</span><br><span class="line">            UNITY_DEFINE_INSTANCED_PROP(<span class="type">float</span>, _PPU)</span><br><span class="line">            UNITY_DEFINE_INSTANCED_PROP(<span class="type">float</span>, _TexIndex)</span><br><span class="line">            UNITY_DEFINE_INSTANCED_PROP(half4, _Pivot)</span><br><span class="line">            UNITY_DEFINE_INSTANCED_PROP(half4, _UV)</span><br><span class="line">            UNITY_DEFINE_INSTANCED_PROP(<span class="type">float</span>, _Upper)</span><br><span class="line">            UNITY_DEFINE_INSTANCED_PROP(<span class="type">float</span>, _OffsetY)</span><br><span class="line">            UNITY_INSTANCING_BUFFER_END(Props)</span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">a2v</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                float4 vertex: POSITION;</span><br><span class="line">                float2 texcoord: TEXCOORD0;</span><br><span class="line">                float4 color: COLOR;</span><br><span class="line">                UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">v2f</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                float4 vertex: SV_POSITION;</span><br><span class="line">                float2 uv: TEXCOORD0;</span><br><span class="line">                float4 color: COLOR;</span><br><span class="line">                float4 local_pos: TEXCOORD1;</span><br><span class="line">                UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            v2f <span class="title function_">vert</span><span class="params">(a2v input)</span></span><br><span class="line">            &#123;</span><br><span class="line">                UNITY_SETUP_INSTANCE_ID(input);</span><br><span class="line"></span><br><span class="line">                v2f output;</span><br><span class="line">                UNITY_TRANSFER_INSTANCE_ID(input, output);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// pivot</span></span><br><span class="line">                half4 pivot = UNITY_ACCESS_INSTANCED_PROP(Props, _Pivot);</span><br><span class="line">                half4x4 pivot_m = &#123;</span><br><span class="line">                    pivot.x, <span class="number">0</span>,       <span class="number">0</span>,      pivot.z,</span><br><span class="line">                    <span class="number">0</span>,       pivot.y, <span class="number">0</span>,      pivot.w,</span><br><span class="line">                    <span class="number">0</span>,       <span class="number">0</span>,       <span class="number">1</span>,      <span class="number">0</span>,</span><br><span class="line">                    <span class="number">0</span>,       <span class="number">0</span>,       <span class="number">0</span>,      <span class="number">1</span></span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="type">float</span> offset_y = UNITY_ACCESS_INSTANCED_PROP(Props, _OffsetY);</span><br><span class="line">                input.vertex = mul(pivot_m, input.vertex);</span><br><span class="line">                input.vertex.y -= offset_y; <span class="comment">// 竖直移动</span></span><br><span class="line">                output.vertex = TransformObjectToHClip(input.vertex.xyz);</span><br><span class="line">                output.local_pos = input.vertex; <span class="comment">// 记录局部坐标用于剔除</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// uv</span></span><br><span class="line">                half4 uv = UNITY_ACCESS_INSTANCED_PROP(Props, _UV);</span><br><span class="line">                half3x3 uv_m = &#123;</span><br><span class="line">                    uv.x, <span class="number">0</span>,    uv.z,</span><br><span class="line">                    <span class="number">0</span>,    uv.y, uv.w,</span><br><span class="line">                    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">1</span></span><br><span class="line">                &#125;;</span><br><span class="line">                output.uv = mul(uv_m, half3(input.texcoord, <span class="number">1</span>)).xy;</span><br><span class="line"></span><br><span class="line">                output.color = input.color * _Color;</span><br><span class="line">                <span class="keyword">return</span> output;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float4 <span class="title function_">frag</span><span class="params">(v2f input)</span> : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">                UNITY_SETUP_INSTANCE_ID(input);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// sprite 剔除</span></span><br><span class="line">                <span class="type">float</span> ppu = UNITY_ACCESS_INSTANCED_PROP(Props, _PPU);</span><br><span class="line">                <span class="type">float</span> upper = UNITY_ACCESS_INSTANCED_PROP(Props, _Upper);</span><br><span class="line">                <span class="type">float</span> is_discard = upper * input.local_pos.y + (<span class="number">1.0</span> / ppu - input.local_pos.y) * (<span class="number">1</span> - upper);</span><br><span class="line">                clip(is_discard);</span><br><span class="line"></span><br><span class="line">                float2 uv = input.uv;</span><br><span class="line">                uv = pixelize_uv(uv, _Textures_TexelSize);</span><br><span class="line">                <span class="type">int</span> tex_index = UNITY_ACCESS_INSTANCED_PROP(Props, _TexIndex);</span><br><span class="line">                float4 col = _Textures.Sample(linear_clamp_sampler, float3(uv, tex_index));</span><br><span class="line">                <span class="keyword">return</span> col * input.color;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>挂上这个脚本后, 原来的 Sprite Renderer 会停止渲染, 渲染的工作交给三个子节点上的 Mesh.<br>最终实现的效果如图5,</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/pixel_water_2.gif" style="zoom:80%;" class alt="图5" /></p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="common-hlsl-与-pixel-art-hlsl"><a href="#common-hlsl-与-pixel-art-hlsl" class="headerlink" title="common.hlsl 与 pixel_art.hlsl"></a>common.hlsl 与 pixel_art.hlsl</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef _INCLUDE_COMMON_HLSL_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _INCLUDE_COMMON_HLSL_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ref: https://docs.unity3d.com/Packages/com.unity.shadergraph@12.1/manual/Blend-Node.html</span></span><br><span class="line"><span class="function"><span class="built_in">float</span> <span class="title">blend_overlay</span>(<span class="params"><span class="built_in">float</span> <span class="keyword">base</span>, <span class="built_in">float</span> blend, <span class="built_in">float</span> opacity</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> result1 = <span class="number">1.0</span> - <span class="number">2.0</span> * (<span class="number">1.0</span> - <span class="keyword">base</span>) * (<span class="number">1.0</span> - blend);</span><br><span class="line">    <span class="built_in">float</span> result2 = <span class="number">2.0</span> * <span class="keyword">base</span> * blend;</span><br><span class="line">    <span class="built_in">float</span> zero_or_one = step(<span class="keyword">base</span>, <span class="number">0.5</span>);</span><br><span class="line">    <span class="built_in">float</span> output = result2 * zero_or_one + (<span class="number">1</span> - zero_or_one) * result1;</span><br><span class="line">    <span class="keyword">return</span> lerp(<span class="keyword">base</span>, output, opacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">float</span> <span class="title">blend_subtract</span>(<span class="params"><span class="built_in">float</span> <span class="keyword">base</span>, <span class="built_in">float</span> blend, <span class="built_in">float</span> opacity</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> lerp(<span class="keyword">base</span>, <span class="keyword">base</span> - blend, opacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float2 <span class="title">blend_subtract</span>(<span class="params">float2 <span class="keyword">base</span>, float2 blend, <span class="built_in">float</span> opacity</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> lerp(<span class="keyword">base</span>, <span class="keyword">base</span> - blend, opacity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// -------------------------------------- Gradient Noise --------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gradient noise</span></span><br><span class="line"><span class="comment">// ref: https://docs.unity3d.com/Packages/com.unity.shadergraph@6.9/manual/Gradient-Noise-Node.html</span></span><br><span class="line"><span class="function">float2 <span class="title">gradient_noise_dir</span>(<span class="params">float2 p</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    p = p % <span class="number">289</span>;</span><br><span class="line">    <span class="built_in">float</span> x = (<span class="number">34</span> * p.x + <span class="number">1</span>) * p.x % <span class="number">289</span> + p.y;</span><br><span class="line">    x = (<span class="number">34</span> * x + <span class="number">1</span>) * x % <span class="number">289</span>;</span><br><span class="line">    x = frac(x / <span class="number">41</span>) * <span class="number">2</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> normalize(float2(x - floor(x + <span class="number">0.5</span>), abs(x) - <span class="number">0.5</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">float</span> <span class="title">gradient_noise</span>(<span class="params">float2 uv, <span class="built_in">float</span> scale</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    float2 p = uv * scale;</span><br><span class="line">    float2 ip = floor(p);</span><br><span class="line">    float2 fp = frac(p);</span><br><span class="line">    <span class="built_in">float</span> d00 = dot(gradient_noise_dir(ip), fp);</span><br><span class="line">    <span class="built_in">float</span> d01 = dot(gradient_noise_dir(ip + float2(<span class="number">0</span>, <span class="number">1</span>)), fp - float2(<span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">float</span> d10 = dot(gradient_noise_dir(ip + float2(<span class="number">1</span>, <span class="number">0</span>)), fp - float2(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">    <span class="built_in">float</span> d11 = dot(gradient_noise_dir(ip + float2(<span class="number">1</span>, <span class="number">1</span>)), fp - float2(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    fp = fp * fp * fp * (fp * (fp * <span class="number">6</span> - <span class="number">15</span>) + <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> lerp(lerp(d00, d01, fp.y), lerp(d10, d11, fp.y), fp.x) + <span class="number">0.5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------------------------------- Gaussian Blur --------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_KERNEL(i, x, y) \</span></span><br><span class="line">    color += kernel[i] * tex.Sample(ss, uv + texel_size.xy * float2(x, y));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Gaussian Blur Function</span></span><br><span class="line"><span class="function">float4 <span class="title">gaussian_blur_3x3</span>(<span class="params">Texture2D tex, SamplerState ss, float2 uv, float2 texel_size</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Gaussian kernel</span></span><br><span class="line">    <span class="built_in">float</span> kernel[<span class="number">9</span>] = &#123;</span><br><span class="line">        <span class="number">0.0625</span>, <span class="number">0.125</span>, <span class="number">0.0625</span>,</span><br><span class="line">        <span class="number">0.125</span>, <span class="number">0.25</span>, <span class="number">0.125</span>,</span><br><span class="line">        <span class="number">0.0625</span>, <span class="number">0.125</span>, <span class="number">0.0625</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sample the texture</span></span><br><span class="line">    float4 color = float4(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">0</span>, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">1</span>,  <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">2</span>,  <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">3</span>, <span class="number">-1</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">4</span>,  <span class="number">0</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">5</span>,  <span class="number">1</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">6</span>, <span class="number">-1</span>,  <span class="number">1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">7</span>,  <span class="number">0</span>,  <span class="number">1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">8</span>,  <span class="number">1</span>,  <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">gaussian_blur_5x5</span>(<span class="params">Texture2D tex, SamplerState ss, float2 uv, float2 texel_size</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Gaussian kernel</span></span><br><span class="line">    <span class="built_in">float</span> kernel[<span class="number">25</span>] = &#123;</span><br><span class="line">        <span class="number">0.00390625</span>, <span class="number">0.015625</span>, <span class="number">0.0234375</span>, <span class="number">0.015625</span>, <span class="number">0.00390625</span>,</span><br><span class="line">        <span class="number">0.015625</span>, <span class="number">0.0625</span>, <span class="number">0.09375</span>, <span class="number">0.0625</span>, <span class="number">0.015625</span>,</span><br><span class="line">        <span class="number">0.0234375</span>, <span class="number">0.09375</span>, <span class="number">0.140625</span>, <span class="number">0.09375</span>, <span class="number">0.0234375</span>,</span><br><span class="line">        <span class="number">0.015625</span>, <span class="number">0.0625</span>, <span class="number">0.09375</span>, <span class="number">0.0625</span>, <span class="number">0.015625</span>,</span><br><span class="line">        <span class="number">0.00390625</span>, <span class="number">0.015625</span>, <span class="number">0.0234375</span>, <span class="number">0.015625</span>, <span class="number">0.00390625</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sample the texture</span></span><br><span class="line">    float4 color = float4(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">0</span>,  <span class="number">-2</span>, <span class="number">-2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">1</span>,  <span class="number">-1</span>, <span class="number">-2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">2</span>,   <span class="number">0</span>, <span class="number">-2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">3</span>,   <span class="number">1</span>, <span class="number">-2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">4</span>,   <span class="number">2</span>, <span class="number">-2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">5</span>,  <span class="number">-2</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">6</span>,  <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">7</span>,   <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">8</span>,   <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">9</span>,   <span class="number">2</span>, <span class="number">-1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">10</span>, <span class="number">-2</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">11</span>, <span class="number">-1</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">12</span>,  <span class="number">0</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">13</span>,  <span class="number">1</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">14</span>,  <span class="number">2</span>,  <span class="number">0</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">15</span>, <span class="number">-2</span>,  <span class="number">1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">16</span>, <span class="number">-1</span>,  <span class="number">1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">17</span>,  <span class="number">0</span>,  <span class="number">1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">18</span>,  <span class="number">1</span>,  <span class="number">1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">19</span>,  <span class="number">2</span>,  <span class="number">1</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">20</span>, <span class="number">-2</span>,  <span class="number">2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">21</span>, <span class="number">-1</span>,  <span class="number">2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">22</span>,  <span class="number">0</span>,  <span class="number">2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">23</span>,  <span class="number">1</span>,  <span class="number">2</span>);</span><br><span class="line">    SAMPLE_KERNEL(<span class="number">24</span>,  <span class="number">2</span>,  <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">gaussian_blur</span>(<span class="params">Texture2D tex, SamplerState ss, float2 uv, float2 texel_size, <span class="built_in">float</span> blur</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    float4 col = float4(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    <span class="built_in">float</span> kernel_sum = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> upper = (blur - <span class="number">1</span>) * <span class="number">0.5</span>;</span><br><span class="line">    <span class="built_in">int</span> lower = -upper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> x = lower; x &lt;= upper; ++x)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> y = lower; y &lt;= upper; ++y)</span><br><span class="line">        &#123;</span><br><span class="line">            kernel_sum++;</span><br><span class="line">            float2 offset = float2(texel_size.x * x, texel_size.y * y);</span><br><span class="line">            col += tex.Sample(ss, uv + offset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    col /= kernel_sum;</span><br><span class="line">    <span class="keyword">return</span> col;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _INCLUDE_PIXEL_ART_HLSL_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _INCLUDE_PIXEL_ART_HLSL_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span></span></span><br><span class="line"></span><br><span class="line">float2 <span class="title function_">pixelize_uv</span><span class="params">(float2 uv, float4 texel_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    float2 tpp = clamp(fwidth(uv) * texel_size.zw, <span class="number">1e-5</span>, <span class="number">1</span>);</span><br><span class="line">    float2 tx = uv * texel_size.zw - <span class="number">0.5</span> * tpp;</span><br><span class="line">    float2 tx_offset = smoothstep(<span class="number">1</span> - tpp, <span class="number">1</span>, frac(tx)) + <span class="number">0.5</span>; <span class="comment">// saturate((frac(tx) + tpp - 1) / tpp) + 0.5;</span></span><br><span class="line">    uv = (<span class="built_in">floor</span>(tx) + tx_offset) * texel_size.xy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 <span class="title function_">pixelize_world_pos</span><span class="params">(float3 world_pos, <span class="type">float</span> ppu)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">floor</span>(world_pos * ppu) / ppu;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Tilemap-的缝隙问题与解决方案"><a href="#Tilemap-的缝隙问题与解决方案" class="headerlink" title="Tilemap 的缝隙问题与解决方案"></a>Tilemap 的缝隙问题与解决方案</h2><p>正文中提到在 tilemap 中使用 高斯模糊 特定情况下可能会有问题, 如果模糊采样的范围(<code>_FoamTexelSize</code>)扩得太大, tile 的表现可能会异常. 具体到泡沫这里的例子, 随着 <code>_FoamTexelSize</code> 的增大, 水体内部的 tile 可能会出现异常的白色.</p>
<p>这个问题要从 tilemap 缝隙问题谈起, 这是一个几乎所有刚开始使用 tilemap 的人都会遇到的一个坑, 表现是 tilemap 在镜头移动过程中会出现缝隙, 即使所使用的 tileset 是严丝合缝的. 关于这个问题, 比较好的解释可以参考 <a target="_blank" rel="noopener" href="https://tiled2unity.readthedocs.io/en/latest/fixing-seams/">Fixing Seams - Tiled2Unity</a>, 简单来说是 shader 在采样 tile 贴图时, 由于数值的精度问题会导致采样到贴图外面. 处理的方法也很多, 一种方式类似 jess 的 tileset 中的处理, 会发现每个 16x16 tile 的外面多一个像素宽度的颜色, 防止采样到 tile 外面后颜色不对导致缝隙. </p>
<p>我使用 <a target="_blank" rel="noopener" href="https://github.com/Seanba/SuperTiled2Unity">Supertile2Unity</a> 这个项目, 把 <a target="_blank" rel="noopener" href="https://www.mapeditor.org/">Tiled</a> 导出的 tilemap 导入到 unity. 在最新版本中, 这个插件会自动分割整张 tileset 纹理, 为了实现 seamless 的 tilemap, 可以手动创建一个 Sprite Atlas, 把这些分割的 sprite 做成一个图集, 此时这些 tile 的图像边缘会自动增加外扩的像素(在 Atlas 不勾选 Alpha Dilation 的情况情况下), 从而避免缝隙的产生. 只是打成图集后, 这些 tile 图片挨得非常近, 只有几个像素的间距(Atlas 检索面板中只能设置 2, 4, 8 个像素距离), 所以模糊采样时, 如果范围太大, 就会采到相邻图片的颜色. 一种解决办法是自定义图集的生成, 扩大图集中每张图片的间距. 这里也有一些坑, 不过和这次的主题差太远就先不提了.</p>
<h1 id="其他参考"><a href="#其他参考" class="headerlink" title="其他参考"></a>其他参考</h1><h2 id="2d游戏水体的参考"><a href="#2d游戏水体的参考" class="headerlink" title="2d游戏水体的参考"></a>2d游戏水体的参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=bJUnVU7eECc">Creating a 2D Water Shader in Unity - YouTube</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YCFiCE1i-As">How to create a Water Tile Map Shader in Godot 4 - 2 minutes tutorial - YouTube</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/zWvEh1Bn-D_wUuxnzY9G7Q">基于屏幕的2D实时反射</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=_iADGsjkLY8">Creating Animated Pixelart Water - Aseprite Tutorial - YouTube</a></li>
</ul>
<h2 id="3d游戏水体的参考"><a href="#3d游戏水体的参考" class="headerlink" title="3d游戏水体的参考"></a>3d游戏水体的参考</h2><p>有时可以从真实水体渲染方案中找找灵感</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://chenglixue.top/?p=45">Unity URP 风格化水 – 放課後ティータイム</a></li>
<li><a target="_blank" rel="noopener" href="https://musoucrow.github.io/2020/09/06/lbbn_water/">在URP实现水面效果 | Musoucrow’ BLOG</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/493766119">Unity 实现平面反射（基于 URP）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/uwatech/p/18413711">TA实践分享：材质与渲染——水体(Unity+UE） - UWATech</a></li>
<li><a target="_blank" rel="noopener" href="https://www.patreon.com/posts/24192529">Making Interactive Water using RenderTexture | Patreon</a></li>
<li><a target="_blank" rel="noopener" href="https://site-builder.wiki/posts/29659">水面シェーダーを作成する方法 [Unity] – Site-Builder.wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/Unity3D/comments/pbwvc0/are_water_shaders_still_popular_breakdown_video/">Are water shaders still popular? (breakdown video) : r/Unity3D</a></li>
<li><a target="_blank" rel="noopener" href="https://halfpastyellow.com/blog/2020/10/01/Yet-Another-Stylised-Water-Shader.html">Yet Another Stylised Water Shader - Half Past Yellow | Blog</a><br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>終わり</li>
</ul>
</div><div class="tags"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/"><i class="fa fa-tag"></i>计算机图形学</a><a href="/tags/unity/"><i class="fa fa-tag"></i>unity</a><a href="/tags/PixelArt/"><i class="fa fa-tag"></i>PixelArt</a><a href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"><i class="fa fa-tag"></i>游戏开发</a></div><div class="post-nav"><a class="next" href="/karakidakenokosyokurasi/">其实是一篇安利文...</a></div><div id="tcomment"></div><script src="https://s4.zstatic.net/ajax/libs/twikoo/1.6.10/twikoo.all.min.js"></script><script>twikoo.init({
  envId: 'https://granvallen.vercel.app',
  el: '#tcomment',
  region: '',
  path: ''
})</script></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">Granvallen.</a> <br /> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> Theme by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>