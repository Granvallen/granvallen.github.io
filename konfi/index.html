<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>如何实现一个简单易用可扩展的导表工具 | Granvallen;Nest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'bf1ecb4728a04112cb191bc2e62aa815';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">如何实现一个简单易用可扩展的导表工具</h1><a id="logo" href="/.">Granvallen;Nest</a><p class="description">面白く生きる</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/about/"><i class="fa fa-terminal"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">如何实现一个简单易用可扩展的导表工具</h1><div class="post-meta">Oct 1, 2025<span> | </span><span class="category"><a href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">游戏开发</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4,230</span><span class="post-meta-item-text"> 字</span></span></span><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%86%99%E4%BA%86-konfi"><span class="toc-number">1.</span> <span class="toc-text">为什么写了 konfi</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-konfi"><span class="toc-number">2.</span> <span class="toc-text">如何使用 konfi</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%AF%87"><span class="toc-number">2.1.</span> <span class="toc-text">使用篇</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E8%A1%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">枚举表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">数据表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">类型系统</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81"><span class="toc-number">2.1.2.1.1.</span> <span class="toc-text">类型支持</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E7%A9%BA%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.2.1.2.</span> <span class="toc-text">可空类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.2.1.3.</span> <span class="toc-text">枚举类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.2.1.4.</span> <span class="toc-text">泛型类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.2.1.5.</span> <span class="toc-text">扩展类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E8%A1%A8"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">分表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E5%80%BC%E8%A1%A8"><span class="toc-number">2.1.3.</span> <span class="toc-text">键值表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">2.1.4.</span> <span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%AF%BC%E5%87%BA"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">增量导出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E6%A0%BC%E4%BE%9D%E8%B5%96"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">表格依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E8%A1%A8%E6%95%88%E7%8E%87"><span class="toc-number">2.1.4.3.</span> <span class="toc-text">导表效率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.4.4.</span> <span class="toc-text">通过配置生成类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%AF%87"><span class="toc-number">2.2.</span> <span class="toc-text">扩展篇</span></a></li></ol></li></ol></div></div><div class="post-content"><p>米娜桑, 我又回来更新了. 这次回归正业, 聊聊几个月前写的一个简单的游戏配置导表工具 <a target="_blank" rel="noopener" href="https://github.com/Granvallen/Konfi">konfi</a>. 起因是 side project 里手写的配置越来越多了, 在配置变得混乱前, 想着还是尽早转移到 excel 管理为好. 于是咱需要一个 excel 的导表工具, 这通常也是游戏项目的基础设施之一. </p>
<h1 id="为什么写了-konfi"><a href="#为什么写了-konfi" class="headerlink" title="为什么写了 konfi"></a>为什么写了 konfi</h1><p>本着找到能用的就绝不手写的原则, 一番检索后, 试了下被提到最多的 <a target="_blank" rel="noopener" href="https://github.com/focus-creative-games/luban">Luban</a>. 毫无疑问, 这是一个强大且成熟的导表框架, 有着非常丰富的特性. 但我觉得它在易用性以及和我项目适配上并不太理想. 其配置语法在我看来也还是有点繁琐的. 并且导出的数据格式主要是基于 json, 然后可根据需要再转成其他语言的数据结构. 我个人认为用 json 去描述游戏配置信息并不够好, 比如 json 竟然不支持用整数做 key, 而用整数 id 做主键的配置表则非常普遍. 其实最理想还是直接把配置导出为所用编程语言的数据结构, 在保留信息的同时也方便读取. 另一方面, luban 对于我的项目而言实在有点过于庞大了, 有太多我几乎用不上的特性, 其源码都是我项目的好几倍了… 于是, 我又尝试了一些实现较简单的开源工具, 但大多又已年久失修. 最后想着这类工具反正是一劳永逸的, 需求也不会特别复杂, 不妨就自己实现一个算了.</p>
<p>konfi 的实现也参考了其他的导表工具的设计, 但总体原则是<strong>简单</strong>, <strong>易用</strong>, <strong>可扩展</strong>. 简单指核心实现不到千行, 只实现最常用的基础功能. 易用是希望无需额外配置, 直接建表即可运行导出, 配置语法简洁, 统一且符合直觉. 可扩展则是说可以方便地增加或修改导出流程和数据类型, 从而更好地适配项目. 接下来就简单聊聊如何使用以及如何扩展 konfi, 就当是 konfi 的使用文档了. 嘛, 话虽这么说, 其实也不算安利啦, 更多是分享一个思路, 毕竟 <strong>konfi 本身就是缺少测试的, 除非你觉得可以解决使用过程中出现的任何问题</strong>. 另外, 有些好用但我目前用不上的特性仍在斟酌中, 也暂时没有实现, 在后面会简单提一嘴.</p>
<h1 id="如何使用-konfi"><a href="#如何使用-konfi" class="headerlink" title="如何使用 konfi"></a>如何使用 konfi</h1><h2 id="使用篇"><a href="#使用篇" class="headerlink" title="使用篇"></a>使用篇</h2><p>有必要先说明一些基础设定. 一般比较常用的有三种配置表, 即<strong>枚举表</strong>, <strong>数据表</strong>, <strong>键值表</strong>. 枚举表用于配置项目中的枚举, 便于在整个项目中引用, 比如职业就可以是一个枚举类型, 有剑士, 小偷等职业. 有了枚举之后可以在项目或数据表中引用. 数据表通常包含了最主要的配置内容, 比如游戏中的角色, 物品信息等, 有非常多的属性数据, 角色此时也应当可以使用职业枚举来配置其职业属性. 键值表包含最简单的 key-value 结构, 用于简单的字典结构数据或杂项配置. 以上也可以看出枚举表应该比其他类型的表优先处理, 这样才能引用枚举表的数据.</p>
<p>在这个 <a target="_blank" rel="noopener" href="https://github.com/Granvallen/Konfi">repo</a> 的 design 目录中有两个示例的 excel 表格, 演示了常用的一些配置方法. 枚举表因为需要优先导出故通常作为单独的 excel 文件. 为了导出 design 内的配置表, 可以直接运行 export_table.py 这个脚本, 配置将导出到 data 目录下.</p>
<p><strong>运行环境 Python 3.11+, 依赖包括 openpyxl(excel 文件读取) 与 black(Python格式输出).</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> konfi <span class="keyword">import</span> Exportor</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    table_dir = <span class="string">&quot;./design&quot;</span></span><br><span class="line">    data_dir = <span class="string">&quot;./data&quot;</span></span><br><span class="line">    writer_ext = <span class="string">&quot;py&quot;</span></span><br><span class="line">    enum_tables = &#123; <span class="string">&quot;枚举&quot;</span> &#125;</span><br><span class="line">    </span><br><span class="line">    exportor = Exportor(</span><br><span class="line">        table_dir = table_dir,</span><br><span class="line">        data_dir = data_dir,</span><br><span class="line">        writer_ext = writer_ext,</span><br><span class="line">        enum_tables = enum_tables,</span><br><span class="line">        is_inc = <span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line">    exportor.run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="枚举表"><a href="#枚举表" class="headerlink" title="枚举表"></a>枚举表</h3><p>先看 枚举.xlsx 文件内容.</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/konfi_1.png" style="zoom:60%;" class alt="枚举表" /></p>
<p>test_enum 这个 sheet 中配置了两个枚举类型, 导表过程会先读取一个目录内的所有 excel 文件, 然后逐文件, 逐 sheet 进行导表操作. 使用 _enum 作为后缀名的 sheet 会视为枚举表, 并用枚举表的导表规则进行导出. </p>
<p>konfi 要求表格内容划分为三个区域, 首先是保留的第一列, 主要用来对单行的内容做标记, 比如标记哪些行是配置行. 在上面的例子中, 使用 !var 标记了枚举表所需的一个配置行, 使用 # 标记了一个注释行. 然后是配置行, 配置行的每一列用于描述该列的数据是什么. 枚举表要求 !var 的配置行有 enum_cls, enum_cls_alias, enum_name, enum_alias, enum_val 这 5 列. 最后则是数据行, 即除第一列和配置行以外的右下区域.</p>
<p>以导出 python 数据结构为例, 这个枚举表导出的内容为<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 枚举.xlsx/test_enum</span></span><br><span class="line"><span class="comment"># export by konfi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassisEnum</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; 职业枚举</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    SWORDMAN = <span class="number">0</span> <span class="comment"># 剑士</span></span><br><span class="line">    BANDIT   = <span class="number">1</span> <span class="comment"># 山贼</span></span><br><span class="line">    ARCHER   = <span class="number">2</span> <span class="comment"># 弓手</span></span><br><span class="line">    THIEF    = <span class="number">3</span> <span class="comment"># 小偷</span></span><br><span class="line">    MAGE     = <span class="number">4</span> <span class="comment"># 魔法使</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CombatAttrEnum</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; 战斗属性枚举</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ATK  = <span class="number">0</span> <span class="comment"># 物攻</span></span><br><span class="line">    MATK = <span class="number">1</span> <span class="comment"># 魔攻</span></span><br><span class="line">    AVO  = <span class="number">2</span> <span class="comment"># 回避</span></span><br><span class="line">    HIT  = <span class="number">3</span> <span class="comment"># 命中</span></span><br><span class="line">    CRIT = <span class="number">4</span> <span class="comment"># 暴击</span></span><br><span class="line">    BLK  = <span class="number">5</span> <span class="comment"># 格挡</span></span><br></pre></td></tr></table></figure></p>
<p>konfi 目前也支持导出 lua 与 json(通过修改 writer_ext 为 lua 或 json), 但我自己只使用 python, 故其他格式的导出支持可能没那么完善. 但理论上通过扩展, konfi 是可以导出任何格式的数据的.</p>
<p>关于枚举表的一些细节</p>
<ul>
<li>枚举值一列需配置整数, 也可以和 python 枚举一样使用 auto 让 konfi 自行决定枚举值.</li>
<li>枚举类型在其他配置表中被引用时, 可以使用 枚举名 或 枚举别名 进行配置, 这一点后面我们会看到例子.</li>
<li>没错, 使用 # 进行注释也借鉴自 python. 在 konfi 中, 这是一个统一的注释语法, 使用 # 不仅可以注释行, 写在配置行的里也可以注释列, 甚至可以写在 excel 或 sheet 名字前进行注释. 被注释的内容会跳过导出处理.</li>
</ul>
<h3 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h3><p>接着我们看内容最复杂的数据表, 测试.xlsx/test.test</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/konfi_2.png" style="zoom:80%;" class alt="数据表" /></p>
<p>上表导出的 python 数据结构为<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试.xlsx/test.test</span></span><br><span class="line"><span class="comment"># export by konfi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># id          : int id</span></span><br><span class="line"><span class="comment"># name        : string 名称</span></span><br><span class="line"><span class="comment"># class       : ClassisEnum? 职业</span></span><br><span class="line"><span class="comment"># level       : int? 等级</span></span><br><span class="line"><span class="comment"># range       : float 攻击距离</span></span><br><span class="line"><span class="comment"># combat_attr : dict_m[CombatAttrEnum,  int] 战斗属性</span></span><br><span class="line"><span class="comment"># combat_attr2: dict[CombatAttrEnum, int] 战斗属性2</span></span><br><span class="line"><span class="comment"># equip       : list_m[int] 装备</span></span><br><span class="line"><span class="comment"># equip2      : list[int] 装备2</span></span><br><span class="line"><span class="comment"># equip3      : set[int] 装备3</span></span><br><span class="line"><span class="keyword">from</span> ...enum <span class="keyword">import</span> ClassisEnum, CombatAttrEnum</span><br><span class="line"></span><br><span class="line">test = &#123;</span><br><span class="line">    <span class="number">1001</span>: &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1001</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;皮皮洛&quot;</span>,</span><br><span class="line">        <span class="string">&quot;class&quot;</span>: ClassisEnum.MAGE,</span><br><span class="line">        <span class="string">&quot;level&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: <span class="number">1.2</span>,</span><br><span class="line">        <span class="string">&quot;combat_attr&quot;</span>: &#123;</span><br><span class="line">            CombatAttrEnum.ATK: <span class="number">1</span>,</span><br><span class="line">            CombatAttrEnum.MATK: <span class="number">50</span>,</span><br><span class="line">            CombatAttrEnum.AVO: <span class="number">10</span>,</span><br><span class="line">            CombatAttrEnum.HIT: <span class="number">100</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;combat_attr2&quot;</span>: &#123;</span><br><span class="line">            CombatAttrEnum.ATK: <span class="number">1</span>,</span><br><span class="line">            CombatAttrEnum.MATK: <span class="number">50</span>,</span><br><span class="line">            CombatAttrEnum.AVO: <span class="number">10</span>,</span><br><span class="line">            CombatAttrEnum.HIT: <span class="number">100</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;equip&quot;</span>: [<span class="number">12</span>, <span class="number">4</span>, <span class="number">0</span>],</span><br><span class="line">        <span class="string">&quot;equip2&quot;</span>: [<span class="number">12</span>, <span class="number">4</span>, <span class="number">0</span>],</span><br><span class="line">        <span class="string">&quot;equip3&quot;</span>: &#123;<span class="number">2</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1002</span>: &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1002</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;布库尔&quot;</span>,</span><br><span class="line">        <span class="string">&quot;class&quot;</span>: ClassisEnum.SWORDMAN,</span><br><span class="line">        <span class="string">&quot;level&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: <span class="number">8.5</span>,</span><br><span class="line">        <span class="string">&quot;combat_attr&quot;</span>: &#123;</span><br><span class="line">            CombatAttrEnum.ATK: <span class="number">50</span>,</span><br><span class="line">            CombatAttrEnum.MATK: <span class="number">1</span>,</span><br><span class="line">            CombatAttrEnum.AVO: <span class="number">10</span>,</span><br><span class="line">            CombatAttrEnum.HIT: <span class="number">100</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;combat_attr2&quot;</span>: &#123;</span><br><span class="line">            CombatAttrEnum.ATK: <span class="number">50</span>,</span><br><span class="line">            CombatAttrEnum.MATK: <span class="number">1</span>,</span><br><span class="line">            CombatAttrEnum.AVO: <span class="number">10</span>,</span><br><span class="line">            CombatAttrEnum.HIT: <span class="number">100</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;equip&quot;</span>: [<span class="number">11</span>, <span class="number">2</span>, <span class="number">34</span>],</span><br><span class="line">        <span class="string">&quot;equip2&quot;</span>: [<span class="number">11</span>, <span class="number">2</span>, <span class="number">34</span>],</span><br><span class="line">        <span class="string">&quot;equip3&quot;</span>: &#123;<span class="number">2</span>, <span class="number">11</span>, <span class="number">34</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意到, 这里的 sheet 名是 test.test, 没有后缀说明是一个普通的数据表. 不过名字中使用了 . 作为分割, 点前面的部分作为这个表数据的<strong>模块名</strong>. 简单来说就是这个表导出的内容会放到 data/test 目录下. 如果没有模块名则会直接放到 data 目录下, 以便于数据管理. 通常同一个功能模块的配置表是单独的一个 excel 文件, 其中的 sheet 使用相同的模块名.</p>
<p>表的第一列出现了几个新的标记</p>
<ul>
<li>!var, 配置字段表示一列数据的变量名</li>
<li>!type, 配置字段表示一列数据的类型名</li>
<li>!lable, 配置字段表示一列数据的标签名, 用于增加额外说明</li>
<li>!param, 用于解析列时提供一些额外的用户设定信息, 比如修改数据类型的解析方式. 后面会解释效果.</li>
<li>使用 # 进行了行注释, 可以看到第一行也用 # 注释了 can_fly 这一列.</li>
</ul>
<p>另一个不同是, 数据表本质是一个字典结构, 所以会需要至少一个主键, 在 !var 配置行前加 * 表示主键, konfi 也支持多级主键.</p>
<h4 id="类型系统"><a href="#类型系统" class="headerlink" title="类型系统"></a>类型系统</h4><p><strong>类型系统</strong>是导表工具要解决的核心问题之一, 一个完善的类型系统会使许多功能的实现成为可能, 比如将数据转成任意语言的原生数据类型, 支持扩展配置的数据类型, 以及进行数据字段的校验等等. konfi 也实现了一个非常简单的类型系统去支持上述这些特性.</p>
<h5 id="类型支持"><a href="#类型支持" class="headerlink" title="类型支持"></a>类型支持</h5><p>之所以需要类型, 是因为我们需要告诉游戏程序如何去理解这些配置数据, 比较常见的有整型, 字符串, 布尔类型等等基础类型. 还有一类被称作泛型类型, 或容器类型, 比如列表, 集合, 字典等. 目前 konfi 内置支持的类型有</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>类型</th>
<th>配置名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>整数</td>
<td>int</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>浮点数</td>
<td>float</td>
<td>0.0</td>
<td></td>
</tr>
<tr>
<td>布尔</td>
<td>bool</td>
<td>False</td>
<td>是/Y/1 为真, 否/N/0 为假</td>
</tr>
<tr>
<td>字符串</td>
<td>string</td>
<td>“”</td>
<td>不需要引号</td>
</tr>
<tr>
<td>列表(单格/多格)</td>
<td>list / list_m</td>
<td>[]</td>
<td>list[int], 默认使用 ‘,’ 分割项</td>
</tr>
<tr>
<td>集合(单格/多格)</td>
<td>set / set_m</td>
<td>set()</td>
<td>set[int], 默认使用 ‘,’ 分割项</td>
</tr>
<tr>
<td>字典(单格/多格)</td>
<td>dict / dict_m</td>
<td>{}</td>
<td>dict[int, int], 默认 ‘:’ 分割键值, ‘,’ 分割项</td>
</tr>
<tr>
<td>枚举</td>
<td>枚举类名</td>
<td></td>
<td>配置对应 枚举值 或 枚举别名</td>
</tr>
</tbody>
</table>
</div>
<p>可以看到这些类型名也都取自 python, 泛型类型的配置方式也类型 python 的类型注释.</p>
<h5 id="可空类型"><a href="#可空类型" class="headerlink" title="可空类型"></a>可空类型</h5><p>如果一个指定类型的表格没有配置会发生什么? 例如上面例子中 <strong>布库尔的等级</strong> 这一数据格就是空的. konfi 也尝试引入了 <strong>可空类型</strong>(nullable) 这一概念, 用以避免 默认值 与 空值 带来的混乱. 通过在任意类型后加 ? 标记一个类型为可空类型. 可空类型在解析一个空格时会作为空值处理, 在 python 中就是 None. 否则会解析为类型的默认值. 所以上面布库尔的等级其实是导出的 None.</p>
<h5 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a>枚举类型</h5><p>枚举类型是一个非常特别的类型, 因为其依赖枚举表导出的数据. 其使用的配置名即枚举表中的枚举类, 例如上面的 职业 这一列, 使用了枚举表中的 ClassisEnum. 而数据可以填 枚举值 或 枚举别名. 其他用法上与基础类型无异.</p>
<h5 id="泛型类型"><a href="#泛型类型" class="headerlink" title="泛型类型"></a>泛型类型</h5><p>konfi 支持的每种泛型类型都有两种配置版本, 单格 与 多格, 可以参考 combat_attr, combat_attr2,  equip, equip2 的配置方式. 前面提到 !param 这个标记, 对于<strong>单格泛型类型</strong>可以用这个标记的配置去修改默认的解析分隔符. 之所以有这个需求是因为如果容器里的类型配置格式比较复杂, 容器默认的分隔符可能被占用, 此时就需要换一个符号来分割. 而对于多格字典类型, 目前使用该标记可以指定配置的字典 key 值.</p>
<h5 id="扩展类型"><a href="#扩展类型" class="headerlink" title="扩展类型"></a>扩展类型</h5><p>konfi 支持自定义类型的扩展, 可以自行决定如何解析配置的数据, 不过会需要一些 python 的编码.</p>
<h4 id="分表"><a href="#分表" class="headerlink" title="分表"></a>分表</h4><p>另外 konfi 也实现了一个简单的分表功能, 可以把一张大表拆成多个 sheet 进行配置, 在导出时合并为一个整体. 需要保证合并的表的配置行一致. 在例子中有 测试.xlsx/#test.test@test2 这张表, 因为使用了 # 对 test.test@test2 进行了注释, 所以没有导出. 去掉 # 将其导出时, @ 之前的部分表示这个子表在导出时应该合并到 test.test 这个表的数据中.</p>
<p>分表的功能在大型表拆分时会有用, 我暂时是用不到这个功能了, 所以缺少测试.</p>
<h3 id="键值表"><a href="#键值表" class="headerlink" title="键值表"></a>键值表</h3><p>键值表是最简单的一种配置表, 通常只需要两列配置项 key 与 val, 例如 测试.xlsx/test_kv, 使用 _kv 后缀的即视为键值表.</p>
<p><img src="https://raw.githubusercontent.com/Granvallen/granvallen.github.io/master/img/konfi_3.png" style="zoom:80%;" class alt="键值表" /></p>
<p>导出的 python 数据为<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试.xlsx/test_kv</span></span><br><span class="line"><span class="comment"># export by konfi</span></span><br><span class="line"><span class="comment"># key: string 键</span></span><br><span class="line"><span class="comment"># val: int 值</span></span><br><span class="line">test_kv = &#123;</span><br><span class="line">    <span class="string">&quot;移动距离&quot;</span>: <span class="number">5</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于键值表其他就没什么可说的了, 我个人是感觉这个键值表功能上还是有点简单了, val 这一列只能是一种类型, 这在作为杂项表时不太便利. 我在考虑是否应该支持更动态的类型, 比如直接支持配置 python 数据或 json 数据, 这在某些时候还是挺方便的.</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>以上就是 konfi 主要功能的使用方式了, 这里再补充一些细节和将来可能会考虑实现的特性(<del>请不用抱任何期待</del>)</p>
<h4 id="增量导出"><a href="#增量导出" class="headerlink" title="增量导出"></a>增量导出</h4><p>这个还是挺有用的, 特别是配置表比较多, 而改动比较少的时候. 姑且实现了一个简单的, 创建 Exportor 时传入 is_inc = True 即可开启增量导表. 开启后导表会在 data 目录生成一个记录每个 sheet 数据 md5 的 json 文件, 如果没有变化则会跳过导出.</p>
<h4 id="表格依赖"><a href="#表格依赖" class="headerlink" title="表格依赖"></a>表格依赖</h4><p>在有些情况下需要规定数据表的导出数据的顺序, 比如进行一些导出后校验等等, 也即此时表格之间是存在依赖关系的, 当前在 konfi 中并没有处理. 仅有的顺序也只是保证 枚举表 的优先导出. </p>
<h4 id="导表效率"><a href="#导表效率" class="headerlink" title="导表效率"></a>导表效率</h4><p>选择 python 实现在一定程度上就是用编码效率换运行效率, 尽管如此, 其实也是可以加入多进程导表, 优化导出流程等加速的方案, 但是目前看不到实现计划, 反……反正又不是不能用!</p>
<h4 id="通过配置生成类型"><a href="#通过配置生成类型" class="headerlink" title="通过配置生成类型"></a>通过配置生成类型</h4><p>我觉得这算一个比较进阶的功能了(luban 已有实现), 增强了配置表的功能, 也降低了扩展自定义类型的难度. 实现设计上需要非常小心, 感觉弄不好就非常鸡肋. 不过我暂时也用不上就是了.</p>
<h2 id="扩展篇"><a href="#扩展篇" class="headerlink" title="扩展篇"></a>扩展篇</h2><p>简单说下 konfi 实现和扩展的思路. 大体思路其实就是先把 sheet 转换为 python 特定的中间数据结构, 然后再把这个数据结构按导出语言进行重构, 写入到配置文件脚本.</p>
<p>konfi 的设计中划分了一些概念, 比如</p>
<ul>
<li>导出器(Exportor), 用于控制整个导表流程</li>
<li>解析器(Parser), 用于把一个 sheet 解析为 python 中间类型数据. 每个解析器可以自行决定如何匹配及处理 sheet.</li>
<li>类型(EType), 即中间类型, 用于描述 sheet 配置数据.</li>
<li>写入器(Writer), 用于把中间数据按特定语言写入到文件导出.</li>
</ul>
<p>其中的每个部分理论上都可进行扩展. 比如对于解析器, 首先需要继承 Parser 类, 然后有两种方式筛选该 Parser 期望处理的 sheet.</p>
<ol>
<li>类变量 match 可以直接列出匹配解析 sheet 的名字</li>
<li>实现 filter 函数, 参数为 openpyxl 的 Worksheet<br>接着需要实现 parse 方法, 确定 sheet 的导出规则. 可以参考已有的数据表解析器(CommonParser).</li>
</ol>
<p>类型扩展是更常用的, 比如下面这个用 python tuple 构造的位置类型.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EPos</span>(<span class="title class_ inherited__">EType</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; 位置坐标</span></span><br><span class="line"><span class="string">        (x, y)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    etype_tag = <span class="string">&quot;pos&quot;</span></span><br><span class="line">    default = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, val: <span class="type">Any</span>, nullable: <span class="built_in">bool</span> = <span class="literal">False</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(val, nullable)</span><br><span class="line">        self._convert()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_convert</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.val <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> self.nullable:</span><br><span class="line">                self.py_val = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.py_val = self.__class__.default</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.py_val = literal_eval(self.val)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;无法将值 <span class="subst">&#123;self.val&#125;</span> 转换为 <span class="subst">&#123;<span class="built_in">type</span>(self).__name__&#125;</span>&quot;</span>) <span class="keyword">from</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><br>扩展类型需要继承自 EType, 确定类型名, 默认值, 以及是否支持多格. 然后实现类型的转换方法 _convert. 目前的这些类型实现得都还是比较简单的, 暂时也没有做校验什么的.</p>
<p>Enjoy.<br>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>終わり</p>
</div><div class="tags"><a href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"><i class="fa fa-tag"></i>游戏开发</a><a href="/tags/Python/"><i class="fa fa-tag"></i>Python</a></div><div class="post-nav"><a class="next" href="/soremachi20/">それ町20周年与石黑正数的问答(译)</a></div><div id="tcomment"></div><script src="https://s4.zstatic.net/ajax/libs/twikoo/1.6.10/twikoo.all.min.js"></script><script>twikoo.init({
  envId: 'https://granvallen.vercel.app',
  el: '#tcomment',
  region: '',
  path: ''
})</script></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Granvallen.</a> <br /> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> Theme by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>